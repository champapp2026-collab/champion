<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Champion of Champions</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Champion">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Champion of Champions">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%230f172a'/><text x='90' y='115' font-size='100' text-anchor='middle' fill='%23fbbf24'>üèÜ</text></svg>">

    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Work+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
    // PWA: Inline manifest via Blob URL
    const manifestData = {
        name: "Champion of Champions",
        short_name: "Champion",
        description: "Sports tracker for the ultimate champions",
        start_url: "./",
        display: "standalone",
        background_color: "#0f172a",
        theme_color: "#0f172a",
        orientation: "portrait",
        icons: [
            {
                src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='100' fill='%230f172a'/><text x='256' y='340' font-size='280' text-anchor='middle'>üèÜ</text></svg>",
                sizes: "512x512",
                type: "image/svg+xml",
                purpose: "any maskable"
            },
            {
                src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' rx='40' fill='%230f172a'/><text x='96' y='130' font-size='110' text-anchor='middle'>üèÜ</text></svg>",
                sizes: "192x192",
                type: "image/svg+xml",
                purpose: "any maskable"
            }
        ]
    };
    const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
    const manifestUrl = URL.createObjectURL(manifestBlob);
    const manifestLink = document.createElement('link');
    manifestLink.rel = 'manifest';
    manifestLink.href = manifestUrl;
    document.head.appendChild(manifestLink);

    // PWA: Register service worker from Blob
    if ('serviceWorker' in navigator) {
        const swCode = `
            const CACHE_NAME = 'champ-v1';
            self.addEventListener('install', e => { self.skipWaiting(); });
            self.addEventListener('activate', e => { e.waitUntil(clients.claim()); });
            self.addEventListener('fetch', e => {
                e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
            });
        `;
        const swBlob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl).catch(() => {});
    }

    // PWA: Install prompt
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const installBtn = document.getElementById('pwa-install-btn');
        if (installBtn) installBtn.classList.remove('hidden');
    });
    function installPWA() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((result) => {
                deferredPrompt = null;
                const installBtn = document.getElementById('pwa-install-btn');
                if (installBtn) installBtn.classList.add('hidden');
            });
        }
    }
    // Detect if already installed
    window.addEventListener('appinstalled', () => {
        const installBtn = document.getElementById('pwa-install-btn');
        if (installBtn) installBtn.classList.add('hidden');
    });
    </script>
    
    <style>
        :root {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --accent-gold: #fbbf24;
            --accent-orange: #f97316;
            --accent-green: #22c55e;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(251, 191, 36, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(249, 115, 22, 0.03) 0%, transparent 50%);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: slideDown 0.6s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .title {
            font-family: 'Bangers', cursive;
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-orange) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 3px;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
            animation: fadeIn 0.6s ease 0.2s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .tab {
            padding: 12px 24px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .tab:hover {
            border-color: var(--accent-gold);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-orange));
            border-color: var(--accent-gold);
            color: var(--bg-main);
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.3);
        }

        .content {
            max-width: 1000px;
            margin: 0 auto;
        }

        .section {
            display: none;
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .section.active {
            display: block;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--accent-gold);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        input, select, button {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Work Sans', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-orange));
            color: var(--bg-main);
            font-weight: 700;
            cursor: pointer;
            border: none;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
            box-shadow: none;
        }

        .leaderboard {
            list-style: none;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg-input);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .leaderboard-item:hover {
            border-color: var(--accent-gold);
            transform: translateX(5px);
        }

        .rank {
            font-family: 'Bangers', cursive;
            font-size: 2rem;
            min-width: 60px;
            color: var(--accent-gold);
        }

        .rank.first { color: #fbbf24; text-shadow: 0 0 20px rgba(251, 191, 36, 0.5); }
        .rank.second { color: #94a3b8; }
        .rank.third { color: #f97316; }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .player-stats {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .points {
            font-family: 'Bangers', cursive;
            font-size: 2rem;
            color: var(--accent-gold);
            margin-left: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .sport-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .sport-btn {
            padding: 16px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .sport-btn:hover {
            border-color: var(--accent-gold);
            transform: scale(1.05);
        }

        .sport-btn.selected {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-orange));
            border-color: var(--accent-gold);
            color: var(--bg-main);
        }

        .game-history {
            list-style: none;
        }

        .game-item {
            background: var(--bg-input);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent-gold);
            transition: all 0.3s ease;
        }

        .game-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .sport-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--accent-gold);
            color: var(--bg-main);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .game-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .game-score {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 8px;
        }

        .winner {
            color: var(--accent-green);
        }

        .darts-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border);
        }

        .hidden {
            display: none !important;
        }

        .player-chip {
            display: inline-block;
            padding: 6px 12px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 20px;
            margin: 4px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .add-player-btn {
            width: auto;
            padding: 8px 16px;
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .info-btn {
            background: none;
            border: none;
            color: var(--accent-gold);
            font-size: 1rem;
            cursor: pointer;
            padding: 0;
            margin-left: 5px;
            width: auto;
            transition: transform 0.2s;
        }

        .info-btn:hover {
            transform: scale(1.2);
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-input);
            transition: .4s;
            border-radius: 34px;
            border: 2px solid var(--border);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 2px;
            background-color: var(--text-secondary);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-gold);
            border-color: var(--accent-gold);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
            background-color: var(--bg-main);
        }

        .poker-player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-main);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .bought-in {
            color: var(--accent-green);
            font-weight: 600;
        }

        .no-buyin {
            color: var(--text-secondary);
        }

        /* Poker Theme */
        .poker-header {
            position: relative;
            text-align: center;
            padding: 20px 15px 15px;
            background: linear-gradient(135deg, #1a472a 0%, #0d2818 50%, #1a472a 100%);
            border-radius: 14px;
            border: 2px solid #2d6b45;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .poker-header::before {
            content: '‚ô† ‚ô• ‚ô£ ‚ô¶';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8rem;
            letter-spacing: 20px;
            opacity: 0.04;
            color: white;
            pointer-events: none;
        }
        .poker-header h3 {
            font-family: 'Bangers', cursive;
            font-size: 1.6rem;
            letter-spacing: 2px;
            color: #f0d060;
            margin: 0;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
            position: relative;
        }
        .poker-suits-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 8px;
            font-size: 1.2rem;
            position: relative;
        }
        .poker-suits-row span { opacity: 0.7; }
        .suit-spade { color: #e0e0e0; }
        .suit-heart { color: #e74c3c; }
        .suit-club { color: #e0e0e0; }
        .suit-diamond { color: #e74c3c; }

        .poker-field {
            background: linear-gradient(180deg, #1a472a 0%, #145a30 100%);
            border: 2px solid #2d6b45;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 15px;
            position: relative;
        }
        .poker-field label {
            color: #c8e6c9 !important;
        }
        .poker-field input {
            background: rgba(0,0,0,0.3) !important;
            border-color: #2d6b45 !important;
            color: #f0f0f0 !important;
        }
        .poker-field input::placeholder {
            color: rgba(200,230,200,0.4) !important;
        }

        .poker-summary-bar {
            background: linear-gradient(135deg, #1a472a, #0d2818);
            border: 2px solid #2d6b45;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }
        .poker-summary-bar::after {
            content: '‚ô†';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 4rem;
            opacity: 0.06;
            color: white;
            pointer-events: none;
        }

        .poker-player-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: linear-gradient(135deg, #1a472a, #0f3320);
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid #2d6b45;
            position: relative;
            overflow: hidden;
        }
        .poker-player-card::before {
            content: attr(data-suit);
            position: absolute;
            right: 70px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2.5rem;
            opacity: 0.07;
            pointer-events: none;
        }
        .poker-player-paid {
            border-left: 4px solid #4caf50;
        }
        .poker-player-unpaid {
            border-left: 4px solid #ff9800;
        }

        .poker-btn {
            background: linear-gradient(135deg, #2d6b45, #1a472a) !important;
            border: 1px solid #3d8b5a !important;
            color: #f0d060 !important;
            font-weight: 700;
        }
        .poker-btn:hover {
            background: linear-gradient(135deg, #3d8b5a, #2d6b45) !important;
        }

        .poker-ace {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 38px;
            background: white;
            color: #1a1a2e;
            border-radius: 4px;
            font-weight: 900;
            font-size: 0.75rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            flex-shrink: 0;
            line-height: 1;
        }
        .poker-ace.red { color: #e74c3c; }

        .poker-empty-table {
            text-align: center;
            padding: 30px 15px;
            color: #6b8f7b;
            background: linear-gradient(135deg, #1a472a, #0d2818);
            border: 2px dashed #2d6b45;
            border-radius: 12px;
        }

        .poker-hand-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: background 0.15s;
            border: 1px solid transparent;
        }
        .poker-hand-row:hover {
            background: rgba(255,255,255,0.05);
            border-color: #2d6b45;
        }
        .poker-hand-rank {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #f0d060, #d4a520);
            color: #1a1a2e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 0.75rem;
            flex-shrink: 0;
        }
        .poker-hand-info {
            flex: 1;
        }
        .poker-hand-name {
            font-weight: 700;
            color: #f0f0f0;
            font-size: 0.9rem;
        }
        .poker-hand-cards {
            font-size: 0.8rem;
            letter-spacing: 2px;
            margin-top: 2px;
            font-weight: 600;
        }
        .poker-hand-detail {
            font-size: 0.75rem;
            color: #8fbc8f;
            margin-top: 4px;
            line-height: 1.4;
            padding: 6px 0 2px;
            border-top: 1px solid rgba(45,107,69,0.3);
        }

        /* Modal for rules */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--bg-card);
            margin: 5% auto;
            padding: 30px;
            border: 2px solid var(--accent-gold);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideDown 0.3s ease;
        }

        .close {
            color: var(--text-secondary);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: var(--accent-gold);
        }

        @media (max-width: 600px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .leaderboard-item {
                flex-direction: column;
                text-align: center;
            }
            
            .rank {
                margin-bottom: 10px;
            }
            
            .points {
                margin: 10px 0 0 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login/Welcome Screen -->
    <!-- Group Code Screen -->
    <div id="group-code-screen" class="content" style="max-width: 500px; margin: 100px auto;">
        <div class="card" style="text-align: center;">
            <h2 style="margin-bottom: 10px; color: var(--accent-gold);">üîê Group Code</h2>
            <p style="color: var(--text-secondary); margin-bottom: 25px;">Enter your group's secret code to access the app. Share this code with your mates ‚Äî everyone uses the same one.</p>
            
            <div class="form-group">
                <label>Secret Code (min 6 characters)</label>
                <input type="password" id="group-code-input" placeholder="Enter your group code" style="text-align: center; font-size: 1.1rem; letter-spacing: 2px;" onkeypress="if(event.key==='Enter')submitGroupCode()">
            </div>
            <div style="display: flex; align-items: center; gap: 8px; justify-content: center; margin-bottom: 20px;">
                <input type="checkbox" id="show-code-toggle" onchange="toggleCodeVisibility()" style="width: auto;">
                <label for="show-code-toggle" style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Show code</label>
            </div>
            <button class="btn" onclick="submitGroupCode()">Enter</button>
            <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 15px;">First time? Make up a code and share it with your group.<br>Your data is stored privately under this code.</p>
        </div>
    </div>

    <div id="login-screen" class="content hidden" style="max-width: 500px; margin: 100px auto;">
        <div class="card" style="text-align: center;">
            <h2 style="margin-bottom: 30px; color: var(--accent-gold);">Welcome Back!</h2>
            
            <div id="login-form">
                <div class="form-group">
                    <label>Select Your Profile</label>
                    <select id="profile-select" style="margin-bottom: 15px;">
                        <option value="">-- Choose Profile --</option>
                    </select>
                    <button class="btn" onclick="loginUser()">Login</button>
                </div>
                
                <div style="margin: 30px 0; color: var(--text-secondary);">OR</div>
                
                <button class="btn btn-secondary" onclick="showCreateProfile()">Create New Profile</button>
            </div>

            <!-- Create Profile Form -->
            <div id="create-profile-form" class="hidden">
                <div class="form-group">
                    <label>Your Name</label>
                    <input type="text" id="new-user-name" placeholder="Enter your name">
                </div>

                <div class="form-group">
                    <label>Email (Optional)</label>
                    <input type="email" id="new-user-email" placeholder="your@email.com">
                </div>

                <button class="btn" onclick="createProfile()">Create Profile</button>
                <button class="btn btn-secondary" onclick="cancelCreateProfile()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="main-app" class="hidden">
        <div class="header">
            <h1 class="title">CHAMPION OF CHAMPIONS</h1>
            <p class="subtitle">Track. Compete. Conquer.</p>
            <div style="text-align: center; margin-top: 10px; font-size: 0.85rem;">
                <span id="firebase-status" style="color: var(--text-secondary);">‚è≥ Connecting to Firebase...</span>
            </div>
        </div>

        <!-- User Dashboard Section -->
        <div class="content" style="max-width: 1000px; margin: 0 auto 30px;">
            <div class="card" style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <div id="current-user-name" style="font-weight: 700; font-size: 1.5rem; margin-bottom: 5px;"></div>
                    <div id="current-user-email" style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;"></div>
                    
                    <!-- Personal Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="text-align: center; padding: 10px; background: var(--bg-input); border-radius: 8px;">
                            <div style="font-family: 'Bangers', cursive; font-size: 1.5rem; color: var(--accent-gold);" id="user-total-points">0</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Total Points</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-input); border-radius: 8px;">
                            <div style="font-family: 'Bangers', cursive; font-size: 1.5rem; color: var(--accent-green);" id="user-total-wins">0</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Wins</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-input); border-radius: 8px;">
                            <div style="font-family: 'Bangers', cursive; font-size: 1.5rem; color: var(--text-primary);" id="user-total-games">0</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Games Played</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-input); border-radius: 8px;">
                            <div style="font-family: 'Bangers', cursive; font-size: 1.5rem; color: var(--accent-orange);" id="user-win-rate">0%</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Win Rate</div>
                        </div>
                    </div>
                </div>
                <div style="margin-left: auto;">
                    <button class="btn btn-secondary" onclick="logoutUser()" style="padding: 10px 20px; font-size: 0.9rem;">Logout</button>
                </div>
            </div>

            <!-- Sport-Specific Averages -->
            <div class="card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;">Your Sport Averages</h3>
                <div id="user-sport-averages" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"></div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="record-game">Record Game</div>
            <div class="tab" data-tab="practice">üéØ Practice</div>
            <div class="tab" data-tab="leaderboard">Leaderboard</div>
            <div class="tab" data-tab="history">History</div>
            <div class="tab" data-tab="settings">Settings</div>
        </div>

    <div class="content">
        <!-- Record Game Section -->
        <div id="record-game" class="section active">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Record a Game</h2>
                
                <div class="form-group">
                    <label>Select Sport</label>
                    <div class="sport-selector">
                        <div class="sport-btn selected" data-sport="Darts">
                            üéØ Darts
                            <button class="info-btn" onclick="showRules('Darts')" title="View rules">‚ìò</button>
                        </div>
                        <div class="sport-btn" data-sport="Pool-US">
                            üé± Pool (US)
                            <button class="info-btn" onclick="showRules('Pool-US')" title="View rules">‚ìò</button>
                        </div>
                        <div class="sport-btn" data-sport="Pool-UK">
                            üé± Pool (UK)
                            <button class="info-btn" onclick="showRules('Pool-UK')" title="View rules">‚ìò</button>
                        </div>
                        <div class="sport-btn" data-sport="Badminton">
                            üè∏ Badminton
                            <button class="info-btn" onclick="showRules('Badminton')" title="View rules">‚ìò</button>
                        </div>
                        <div class="sport-btn" data-sport="Poker">
                            üÉè Poker
                            <button class="info-btn" onclick="showRules('Poker')" title="View rules">‚ìò</button>
                        </div>
                        <div class="sport-btn" data-sport="Custom">‚ûï Add Sport</div>
                    </div>
                </div>

                <div id="custom-sport-input" class="form-group hidden">
                    <label>New Sport Name</label>
                    <input type="text" id="new-sport-name" placeholder="Enter sport name">
                    <button class="btn btn-secondary" onclick="addCustomSport()">Add Sport</button>
                </div>

                <div id="game-type-section">
                <div class="form-group">
                    <label>Game Type</label>
                    <div class="grid">
                        <div class="sport-btn" id="singles-btn" onclick="selectGameType('singles')">Singles</div>
                        <div class="sport-btn" id="teams-btn" onclick="selectGameType('teams')">Teams</div>
                    </div>
                </div>
                </div>

                <div id="players-section">
                    <div class="form-group">
                        <label>Player 1</label>
                        <input type="text" id="player1" placeholder="Enter player name" list="profile-names">
                    </div>
                    <div class="form-group">
                        <label>Player 2</label>
                        <input type="text" id="player2" placeholder="Enter player name" list="profile-names">
                    </div>
                </div>

                <div id="teams-section" class="hidden">
                    <div class="form-group">
                        <label>Team 1 Players</label>
                        <div id="team1-players"></div>
                        <input type="text" id="team1-input" placeholder="Enter player name" list="profile-names">
                        <button class="btn btn-secondary add-player-btn" onclick="addTeamPlayer('team1')">Add Player</button>
                    </div>
                    <div class="form-group">
                        <label>Team 2 Players</label>
                        <div id="team2-players"></div>
                        <input type="text" id="team2-input" placeholder="Enter player name" list="profile-names">
                        <button class="btn btn-secondary add-player-btn" onclick="addTeamPlayer('team2')">Add Player</button>
                    </div>
                </div>

                <!-- Darts Specific -->
                <div id="darts-scoring" class="darts-section hidden">
                    <!-- Setup Mode -->
                    <div id="darts-setup">
                        <h3 style="margin-bottom: 15px;">Darts Game Setup</h3>
                        <div class="form-group">
                            <label>Game Mode</label>
                            <div class="grid">
                                <div class="sport-btn selected" id="mode-501" onclick="selectDartsMode(501)">501</div>
                                <div class="sport-btn" id="mode-301" onclick="selectDartsMode(301)">301</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>First to Win</label>
                            <div class="grid">
                                <div class="sport-btn selected" id="legs-1" onclick="selectLegsToWin(1)">1 Leg</div>
                                <div class="sport-btn" id="legs-3" onclick="selectLegsToWin(3)">Best of 3</div>
                                <div class="sport-btn" id="legs-5" onclick="selectLegsToWin(5)">Best of 5</div>
                            </div>
                        </div>
                        <button class="btn" onclick="startDartsGame()">Start Game</button>
                    </div>

                    <!-- Active Game Mode -->
                    <div id="darts-game" class="hidden">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 id="game-mode-display">501</h3>
                            <button class="btn btn-secondary" style="width: auto; padding: 8px 16px;" onclick="endDartsGame()">End Game</button>
                        </div>

                        <!-- Scoreboard -->
                        <div class="grid" style="margin-bottom: 20px;">
                            <div class="card" id="player1-card" style="background: var(--bg-input); padding: 20px; text-align: center; border: 3px solid transparent;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;" id="p1-name-display">Player 1</div>
                                <div style="font-family: 'Bangers', cursive; font-size: 3rem; color: var(--accent-gold);" id="p1-score-display">501</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    Avg: <span id="p1-avg-display">0.00</span> | Legs: <span id="p1-legs-display">0</span>
                                </div>
                                <div id="p1-checkout" style="margin-top: 10px; padding: 8px; background: var(--bg-main); border-radius: 8px; font-size: 0.9rem; min-height: 40px;"></div>
                            </div>
                            <div class="card" id="player2-card" style="background: var(--bg-input); padding: 20px; text-align: center; border: 3px solid transparent;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;" id="p2-name-display">Player 2</div>
                                <div style="font-family: 'Bangers', cursive; font-size: 3rem; color: var(--accent-gold);" id="p2-score-display">501</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    Avg: <span id="p2-avg-display">0.00</span> | Legs: <span id="p2-legs-display">0</span>
                                </div>
                                <div id="p2-checkout" style="margin-top: 10px; padding: 8px; background: var(--bg-main); border-radius: 8px; font-size: 0.9rem; min-height: 40px;"></div>
                            </div>
                        </div>

                        <!-- Current Turn -->
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 10px;">
                                <span id="current-player-turn">Player 1</span>'s Turn
                            </div>
                        </div>

                        <!-- Score Input -->
                        <div class="card" style="background: var(--bg-input);">
                            <h4 style="margin-bottom: 15px;">Enter Score</h4>
                            
                            <!-- Quick Score Buttons -->
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 15px;">
                                <button class="btn btn-secondary" onclick="quickScore(26)">26</button>
                                <button class="btn btn-secondary" onclick="quickScore(41)">41</button>
                                <button class="btn btn-secondary" onclick="quickScore(45)">45</button>
                                <button class="btn btn-secondary" onclick="quickScore(60)">60</button>
                                <button class="btn btn-secondary" onclick="quickScore(81)">81</button>
                                <button class="btn btn-secondary" onclick="quickScore(85)">85</button>
                                <button class="btn btn-secondary" onclick="quickScore(100)">100</button>
                                <button class="btn btn-secondary" onclick="quickScore(140)">140</button>
                                <button class="btn btn-secondary" onclick="quickScore(180)">180</button>
                                <button class="btn btn-secondary" onclick="quickScore(0)">0</button>
                            </div>

                            <!-- Custom Score Input -->
                            <div class="form-group">
                                <label>Custom Score (0-180)</label>
                                <input type="number" id="custom-dart-score" min="0" max="180" placeholder="Enter score">
                            </div>

                            <button class="btn" onclick="submitDartScore()">Submit Score</button>
                            <button class="btn btn-secondary" onclick="undoLastDart()">Undo Last</button>
                        </div>

                        <!-- Throw History -->
                        <div class="card" style="margin-top: 20px; max-height: 200px; overflow-y: auto;">
                            <h4 style="margin-bottom: 15px;">Throw History</h4>
                            <div id="throw-history"></div>
                        </div>
                    </div>
                </div>

                <!-- Regular Scoring -->
                <div id="regular-scoring">
                    <div class="grid">
                        <div class="form-group">
                            <label id="score1-label">Player 1 Score</label>
                            <input type="number" id="score1" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label id="score2-label">Player 2 Score</label>
                            <input type="number" id="score2" min="0" value="0">
                        </div>
                    </div>
                </div>

                <!-- Poker Specific -->
                <div id="poker-scoring" class="darts-section hidden">
                    
                    <!-- Poker Header -->
                    <div class="poker-header">
                        <h3>‚ô† Poker Night ‚ô•</h3>
                        <div class="poker-suits-row">
                            <span class="suit-spade">‚ô†</span>
                            <span class="suit-heart">‚ô•</span>
                            <span class="suit-club">‚ô£</span>
                            <span class="suit-diamond">‚ô¶</span>
                        </div>
                    </div>

                    <!-- Poker Rules Viewer -->
                    <div style="margin-bottom: 20px;">
                        <button class="btn poker-btn" onclick="togglePokerRules()" style="width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;">
                            <span>üìú Poker Night Rules</span>
                            <span id="poker-rules-arrow" style="transition: transform 0.2s;">‚ñº</span>
                        </button>
                        <div id="poker-rules-panel" class="hidden" style="margin-top: 10px; padding: 20px; background: linear-gradient(135deg, #1a472a, #0d2818); border-radius: 12px; border: 2px solid #2d6b45; max-height: 500px; overflow-y: auto;">
                            <div style="text-align: center; margin-bottom: 15px;">
                                <h3 style="color: var(--accent-gold); margin-bottom: 5px;">Champion of Champions</h3>
                                <p style="color: #8fbc8f; font-size: 0.85rem;">Founding Members: James Purtell, Jacob Spyer, Freddie Spyer, Oliver Clinch, Jack Posmore, Tom Bunce</p>
                                <p style="color: #8fbc8f; font-size: 0.8rem; font-style: italic; margin-top: 6px;">The book of rules is the law and all motions shall be updated in the app for the following session.</p>
                            </div>
                            <ol style="line-height: 2; padding-left: 20px; margin-bottom: 0; color: #c8e6c9;">
                                <li>If you leave before the end, chips are discarded (not given to any living being)</li>
                                <li>At the end of the evening a new date is set for the next match</li>
                                <li>Min buy in is ¬£10. Buy ins then follow on the original amount</li>
                                <li>Texas Hold'em will be the Poker game for the first game</li>
                                <li>Over the course of the year wins will be documented ‚Äî the winner will receive a cup bought by the Founding Members üèÜ</li>
                                <li>Upon sitting at the table all players must consume 1 shot of limoncello üçã</li>
                                <li style="margin-bottom: 8px;">Buy in consists of:
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px; margin-top: 6px; font-size: 0.9rem;">
                                        <span style="background: #FF6B00; color: white; padding: 4px 10px; border-radius: 6px; text-align: center;">3 √ó 1000 Orange</span>
                                        <span style="background: #8B5CF6; color: white; padding: 4px 10px; border-radius: 6px; text-align: center;">4 √ó 500 Purple</span>
                                        <span style="background: #1a1a2e; color: white; padding: 4px 10px; border-radius: 6px; text-align: center; border: 1px solid #555;">7 √ó 100 Black</span>
                                        <span style="background: #3B82F6; color: white; padding: 4px 10px; border-radius: 6px; text-align: center;">5 √ó 50 Blue</span>
                                        <span style="background: #22C55E; color: white; padding: 4px 10px; border-radius: 6px; text-align: center;">5 √ó 25 Green</span>
                                    </div>
                                </li>
                                <li>NO COINS</li>
                                <li>10:00 ‚Äî Last buy ins, however this can be changed by the host</li>
                                <li>No Consoling</li>
                                <li>A Host can decide upon attire for the evening</li>
                                <li>To create a new rule there must be a majority Vote & Motion to commit the rule</li>
                                <li>No Trading of Coins for favours</li>
                                <li>Suits on the last game üé©</li>
                                <li>Air BNB last game / where the first game hosted</li>
                                <li>First blind stage consists of 10 games, 11th game double the blind, 3√ó rounds then double again</li>
                            </ol>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2d6b45;">
                                <strong style="color: var(--accent-gold);">Additional Rules:</strong>
                                <ul style="line-height: 2; padding-left: 20px; margin-top: 8px; margin-bottom: 0; color: #c8e6c9;">
                                    <li>No consulting</li>
                                    <li>2 decks per game</li>
                                    <li>To become a founder you have to win</li>
                                    <li>No motions during a round</li>
                                    <li>When a rule is broken ‚Äî punishment is a shot ü•É</li>
                                    <li>No more than 3 min between rounds ‚Äî if more, a shot is owed</li>
                                    <li>If anyone is proposed to trial a new game and it is majority voted in, it will be done at the next poker night</li>
                                    <li>Once we get to 20:00, increments are 200</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Hand Rankings Viewer -->
                    <div style="margin-bottom: 20px;">
                        <button class="btn poker-btn" onclick="togglePokerHands()" style="width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;">
                            <span>üÇ° Hand Rankings ‚Äî Texas Hold'em</span>
                            <span id="poker-hands-arrow" style="transition: transform 0.2s;">‚ñº</span>
                        </button>
                        <div id="poker-hands-panel" class="hidden" style="margin-top: 10px; padding: 15px; background: linear-gradient(135deg, #1a472a, #0d2818); border-radius: 12px; border: 2px solid #2d6b45; max-height: 500px; overflow-y: auto;">
                            <div style="text-align: center; margin-bottom: 12px;">
                                <div style="font-family: 'Bangers', cursive; color: #f0d060; font-size: 1.1rem;">Best to Worst</div>
                                <div style="font-size: 0.7rem; color: #6b8f7b;">Tap a hand to see details</div>
                            </div>

                            <div id="poker-hands-list">
                                <div class="poker-hand-row" onclick="this.querySelector('.poker-hand-detail').classList.toggle('hidden')">
                                    <div class="poker-hand-rank">1</div>
                                    <div class="poker-hand-info">
                                        <div class="poker-hand-name">Royal Flush</div>
                                        <div class="poker-hand-cards"><span class="suit-heart">A‚ô•</span> <span class="suit-heart">K‚ô•</span> <span class="suit-heart">Q‚ô•</span> <span class="suit-heart">J‚ô•</span> <span class="suit-heart">10‚ô•</span></div>
                                        <div class="poker-hand-detail hidden">A, K, Q, J, 10 all of the same suit. The best possible hand.</div>
                                    </div>
                                </div>

                                <div class="poker-hand-row" onclick="this.querySelector('.poker-hand-detail').classList.toggle('hidden')">
                                    <div class="poker-hand-rank">2</div>
                                    <div class="poker-hand-info">
                                        <div class="poker-hand-name">Straight Flush</div>
                                        <div class="poker-hand-cards"><span class="suit-spade">9‚ô†</span> <span class="suit-spade">8‚ô†</span> <span class="suit-spade">7‚ô†</span> <span class="suit-spade">6‚ô†</span> <span class="suit-spade">5‚ô†</span></div>
                                        <div class="poker-hand-detail hidden">Five consecutive cards of the same suit. Higher top card wins ties.</div>
                                    </div>
                                </div>

                                <div class="poker-hand-row" onclick="this.querySelector('.poker-hand-detail').classList.toggle('hidden')">
                                    <div class="poker-hand-rank">3</div>
                                    <div class="poker-hand-info">
                                        <div class="poker-hand-name">Four of a Kind</div>
                                        <div class="poker-hand-cards"><span class="suit-spade">K‚ô†</span> <span class="suit-heart">K‚ô•</span> <span class="suit-club">K‚ô£</span> <span class="suit-diamond">K‚ô¶</span> <span class="suit-spade">2‚ô†</span></div>
                                        <div class="poker-hand-detail hidden">Four cards of the same rank. Higher rank wins. Fifth card (kicker) breaks ties.</div>
                                    </div>
                                </div>

                                <div class="poker-hand-row" onclick="this.querySelector('.poker-hand-detail').classList.toggle('hidden')">
                                    <div class="poker-hand-rank">4</div>
                                    <div class="poker-hand-info">
                                        <div class="poker-hand-name">Full House</div>
                                        <div class="poker-hand-cards"><span class="suit-heart">Q‚ô•</span> <span class="suit-diamond">Q‚ô¶</span> <span class="suit-spade">Q‚ô†</span> <span class="suit-club">8‚ô£</span> <span class="suit-heart">8‚ô•</span></div>
                                        <div class="poker-hand-detail hidden">Three of a kind plus a pair. The three-of-a-kind rank decides ties, then the pair.</div>
                                    </div>
                                </div>

                                <div class="poker-hand-row" onclick="this.querySelector('.poker-hand-detail').classList.toggle('hidden')">
                                    <div class="poker-hand-rank">5</div>
                                    <div class="poker-hand-info">
                                        <div class="poker-hand-name">Flush</div>
                                        <div class="poker-hand-cards"><span class="suit-diamond">A‚ô¶</span> <span class="suit-diamond">J‚ô¶</span> <span class="suit-diamond">9‚ô¶</span> <span class="suit-diamond">6‚ô¶</span> <span class="suit-diamond">3‚ô¶</span></div>
                                        <div class="poker-hand-detail hidden">Five cards of the same suit, not in sequence. Highest card wins ties, then next highest, etc.</div>
                                    </div>
                                </div>

                                <div class="poker-hand-row" onclick="this.querySelector('.poker-hand-detail').classList.toggle('hidden')">
                                    <div class="poker-hand-rank">6</div>
                                    <div class="poker-hand-info">
                                        <div class="poker-hand-name">Straight</div>
                                        <div class="poker-hand-cards"><span class="suit-club">10‚ô£</span> <span class="suit-diamond">9‚ô¶</span> <span class="suit-heart">8‚ô•</span> <span class="suit-spade">7‚ô†</span> <span class="suit-club">6‚ô£</span></div>
                                        <div class="poker-hand-detail hidden">Five consecutive cards of mixed suits. Ace can be high (A-K-Q-J-10) or low (5-4-3-2-A). Higher top card wins.</div>
                                    </div>
                                </div>

                                <div class="poker-hand-row" onclick="this.querySelector('.poker-hand-detail').classList.toggle('hidden')">
                                    <div class="poker-hand-rank">7</div>
                                    <div class="poker-hand-info">
                                        <div class="poker-hand-name">Three of a Kind</div>
                                        <div class="poker-hand-cards"><span class="suit-spade">7‚ô†</span> <span class="suit-heart">7‚ô•</span> <span class="suit-diamond">7‚ô¶</span> <span class="suit-club">K‚ô£</span> <span class="suit-spade">3‚ô†</span></div>
                                        <div class="poker-hand-detail hidden">Three cards of the same rank. Higher rank wins. Remaining cards (kickers) break ties.</div>
                                    </div>
                                </div>

                                <div class="poker-hand-row" onclick="this.querySelector('.poker-hand-detail').classList.toggle('hidden')">
                                    <div class="poker-hand-rank">8</div>
                                    <div class="poker-hand-info">
                                        <div class="poker-hand-name">Two Pair</div>
                                        <div class="poker-hand-cards"><span class="suit-heart">J‚ô•</span> <span class="suit-spade">J‚ô†</span> <span class="suit-diamond">4‚ô¶</span> <span class="suit-club">4‚ô£</span> <span class="suit-heart">A‚ô•</span></div>
                                        <div class="poker-hand-detail hidden">Two different pairs. Higher pair wins ties, then second pair, then kicker.</div>
                                    </div>
                                </div>

                                <div class="poker-hand-row" onclick="this.querySelector('.poker-hand-detail').classList.toggle('hidden')">
                                    <div class="poker-hand-rank">9</div>
                                    <div class="poker-hand-info">
                                        <div class="poker-hand-name">One Pair</div>
                                        <div class="poker-hand-cards"><span class="suit-club">10‚ô£</span> <span class="suit-diamond">10‚ô¶</span> <span class="suit-spade">A‚ô†</span> <span class="suit-heart">8‚ô•</span> <span class="suit-club">5‚ô£</span></div>
                                        <div class="poker-hand-detail hidden">Two cards of the same rank. Higher pair wins. Kickers break ties in order.</div>
                                    </div>
                                </div>

                                <div class="poker-hand-row" onclick="this.querySelector('.poker-hand-detail').classList.toggle('hidden')">
                                    <div class="poker-hand-rank">10</div>
                                    <div class="poker-hand-info">
                                        <div class="poker-hand-name">High Card</div>
                                        <div class="poker-hand-cards"><span class="suit-spade">A‚ô†</span> <span class="suit-heart">J‚ô•</span> <span class="suit-diamond">8‚ô¶</span> <span class="suit-club">5‚ô£</span> <span class="suit-heart">2‚ô•</span></div>
                                        <div class="poker-hand-detail hidden">No combination. Highest card wins. If tied, compare next highest, and so on.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="poker-field">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <span class="poker-ace">A<br>‚ô†</span> Buy-in Amount (¬£)
                            </label>
                            <input type="number" id="poker-buyin" min="0" step="1" placeholder="e.g., 10" value="10">
                        </div>
                    </div>

                    <div class="poker-field">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <span class="poker-ace red">A<br>‚ô•</span> Add Players
                            </label>
                            
                            <!-- Quick-add from profiles -->
                            <div id="poker-profile-buttons" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                        </div>
                    </div>

                    <!-- Player List -->
                    <div id="poker-players-list" style="margin-bottom: 15px;">
                        <div style="color: var(--text-secondary); padding: 15px; text-align: center;">No players added yet</div>
                    </div>

                    <!-- Session Summary -->
                    <div id="poker-session-summary" class="hidden poker-summary-bar">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; position: relative;">
                            <div>
                                <div style="font-family: 'Bangers', cursive; font-size: 1.4rem; color: #f0d060;" id="poker-total-players">0</div>
                                <div style="font-size: 0.75rem; color: #8fbc8f;">‚ô£ Players</div>
                            </div>
                            <div>
                                <div style="font-family: 'Bangers', cursive; font-size: 1.4rem; color: #4caf50;" id="poker-total-paid">0</div>
                                <div style="font-size: 0.75rem; color: #8fbc8f;">‚ô† Paid</div>
                            </div>
                            <div>
                                <div style="font-family: 'Bangers', cursive; font-size: 1.4rem; color: #f0d060;" id="poker-total-pot">¬£0</div>
                                <div style="font-size: 0.75rem; color: #8fbc8f;">‚ô¶ Total Pot</div>
                            </div>
                        </div>
                    </div>

                    <div id="poker-players-final" class="hidden">
                        <div class="poker-field">
                            <h4 style="margin: 0 0 8px; color: #f0d060; display: flex; align-items: center; gap: 8px;">
                                <span class="poker-ace">A<br>‚ô£</span> Placements & Final Amounts
                            </h4>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; flex-wrap: wrap;">
                                <span style="font-size: 0.75rem; color: #c8e6c9; background: rgba(0,0,0,0.25); padding: 4px 10px; border-radius: 20px;">ü•á 1st = 3pts</span>
                                <span style="font-size: 0.75rem; color: #c8e6c9; background: rgba(0,0,0,0.25); padding: 4px 10px; border-radius: 20px;">ü•àü•â 2nd‚Äì3rd = 2pts</span>
                                <span style="font-size: 0.75rem; color: #c8e6c9; background: rgba(0,0,0,0.25); padding: 4px 10px; border-radius: 20px;">4th‚Äì5th = 1pt</span>
                            </div>
                            <div id="poker-finals-list"></div>
                            <button class="btn poker-btn" onclick="savePokerSession()" style="margin-top: 10px;">‚ô† Save Poker Session ‚ô†</button>
                        </div>
                    </div>

                    <button class="btn poker-btn" onclick="finishPokerSetup()" id="poker-setup-done">‚ô¶ Continue to Final Amounts ‚ô¶</button>
                </div>

                <button class="btn" id="save-game-btn" onclick="saveGame()">Save Game</button>
                <datalist id="profile-names"></datalist>
            </div>
        </div>

        <!-- Practice Section -->
        <div id="practice" class="section">
            <!-- Practice Mode Selection -->
            <div id="practice-menu" class="card">
                <h2 style="margin-bottom: 20px;">üéØ Darts Practice</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Choose a practice mode to sharpen your game.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="sport-btn" onclick="startPractice('solo')" style="padding: 20px; text-align: left;">
                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üéØ</div>
                        <div style="font-weight: 700; margin-bottom: 4px;">Solo Scoring</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Track your throws & build your average</div>
                    </div>
                    <div class="sport-btn" onclick="startPractice('checkout')" style="padding: 20px; text-align: left;">
                        <div style="font-size: 1.5rem; margin-bottom: 8px;">‚úÖ</div>
                        <div style="font-weight: 700; margin-bottom: 4px;">Checkout Practice</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Random finishes ‚Äî can you check out?</div>
                    </div>
                    <div class="sport-btn" onclick="startPractice('rtb')" style="padding: 20px; text-align: left;">
                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üîÑ</div>
                        <div style="font-weight: 700; margin-bottom: 4px;">Round the Board</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Hit 1‚Äì20 in order. How few darts?</div>
                    </div>
                    <div class="sport-btn" onclick="startPractice('cpu')" style="padding: 20px; text-align: left;">
                        <div style="font-size: 1.5rem; margin-bottom: 8px;">ü§ñ</div>
                        <div style="font-weight: 700; margin-bottom: 4px;">VS Computer</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">10 difficulty levels ‚Äî test yourself</div>
                    </div>
                </div>
            </div>

            <!-- Solo Scoring Practice -->
            <div id="practice-solo" class="card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Solo Scoring</h3>
                    <button class="btn btn-secondary" style="width: auto; padding: 8px 16px;" onclick="endPractice()">Back</button>
                </div>
                <div class="form-group">
                    <label>Game Mode</label>
                    <div class="grid">
                        <div class="sport-btn selected" id="solo-mode-501" onclick="selectSoloMode(501)">501</div>
                        <div class="sport-btn" id="solo-mode-301" onclick="selectSoloMode(301)">301</div>
                    </div>
                </div>
                <div id="solo-setup">
                    <button class="btn" onclick="startSoloPractice()">Start Practice</button>
                </div>
                <div id="solo-active" class="hidden">
                    <div class="card" style="background: var(--bg-input); padding: 20px; text-align: center; margin-bottom: 20px;">
                        <div style="font-family: 'Bangers', cursive; font-size: 4rem; color: var(--accent-gold);" id="solo-score-display">501</div>
                        <div style="display: flex; justify-content: center; gap: 30px; margin-top: 10px;">
                            <div><span style="color: var(--text-secondary);">3-Dart Avg:</span> <strong id="solo-avg">0.00</strong></div>
                            <div><span style="color: var(--text-secondary);">Darts:</span> <strong id="solo-darts">0</strong></div>
                            <div><span style="color: var(--text-secondary);">Highest:</span> <strong id="solo-highest">0</strong></div>
                        </div>
                        <div id="solo-checkout" style="margin-top: 10px; padding: 8px; background: var(--bg-main); border-radius: 8px; font-size: 0.9rem; min-height: 30px;"></div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 15px;">
                        <button class="btn btn-secondary" onclick="soloQuickScore(26)">26</button>
                        <button class="btn btn-secondary" onclick="soloQuickScore(41)">41</button>
                        <button class="btn btn-secondary" onclick="soloQuickScore(45)">45</button>
                        <button class="btn btn-secondary" onclick="soloQuickScore(60)">60</button>
                        <button class="btn btn-secondary" onclick="soloQuickScore(81)">81</button>
                        <button class="btn btn-secondary" onclick="soloQuickScore(85)">85</button>
                        <button class="btn btn-secondary" onclick="soloQuickScore(100)">100</button>
                        <button class="btn btn-secondary" onclick="soloQuickScore(140)">140</button>
                        <button class="btn btn-secondary" onclick="soloQuickScore(180)">180</button>
                        <button class="btn btn-secondary" onclick="soloQuickScore(0)">0</button>
                    </div>
                    <div class="form-group">
                        <input type="number" id="solo-custom-score" min="0" max="180" placeholder="Custom score (0-180)">
                    </div>
                    <button class="btn" onclick="submitSoloScore()">Submit</button>
                    <button class="btn btn-secondary" onclick="undoSoloScore()">Undo</button>
                    <button class="btn btn-secondary" style="margin-top: 10px;" onclick="resetSoloPractice()">Reset Leg</button>
                    <div class="card" style="margin-top: 20px; max-height: 150px; overflow-y: auto; background: var(--bg-input);">
                        <h4 style="margin-bottom: 10px;">Throws</h4>
                        <div id="solo-throw-history"></div>
                    </div>
                </div>
            </div>

            <!-- Checkout Practice -->
            <div id="practice-checkout" class="card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Checkout Practice</h3>
                    <button class="btn btn-secondary" style="width: auto; padding: 8px 16px;" onclick="endPractice()">Back</button>
                </div>
                <div id="checkout-active">
                    <div class="card" style="background: var(--bg-input); padding: 30px; text-align: center; margin-bottom: 20px;">
                        <div style="color: var(--text-secondary); margin-bottom: 5px;">You need to check out:</div>
                        <div style="font-family: 'Bangers', cursive; font-size: 5rem; color: var(--accent-gold);" id="checkout-target">‚Äî</div>
                        <div id="checkout-suggestion" style="margin-top: 10px; padding: 8px; background: var(--bg-main); border-radius: 8px; color: var(--accent-green); font-weight: 600;"></div>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="text-align: center; padding: 10px 20px; background: var(--bg-input); border-radius: 8px;">
                            <div style="font-family: 'Bangers', cursive; font-size: 2rem; color: var(--accent-green);" id="checkout-hits">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Hits</div>
                        </div>
                        <div style="text-align: center; padding: 10px 20px; background: var(--bg-input); border-radius: 8px;">
                            <div style="font-family: 'Bangers', cursive; font-size: 2rem; color: var(--accent-orange);" id="checkout-misses">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Misses</div>
                        </div>
                        <div style="text-align: center; padding: 10px 20px; background: var(--bg-input); border-radius: 8px;">
                            <div style="font-family: 'Bangers', cursive; font-size: 2rem; color: var(--accent-gold);" id="checkout-rate">0%</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Hit Rate</div>
                        </div>
                        <div style="text-align: center; padding: 10px 20px; background: var(--bg-input); border-radius: 8px;">
                            <div style="font-family: 'Bangers', cursive; font-size: 2rem; color: var(--text-primary);" id="checkout-darts-used">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Darts Thrown</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Enter your 3-dart score</label>
                        <input type="number" id="checkout-score-input" min="0" max="180" placeholder="Score this visit">
                    </div>
                    <button class="btn" onclick="submitCheckoutScore()">Submit</button>
                    <button class="btn btn-secondary" onclick="skipCheckout()">Skip (Miss)</button>
                    <button class="btn btn-secondary" style="margin-top: 10px;" onclick="startCheckoutPractice()">New Target</button>
                </div>
            </div>

            <!-- Round the Board -->
            <div id="practice-rtb" class="card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Round the Board</h3>
                    <button class="btn btn-secondary" style="width: auto; padding: 8px 16px;" onclick="endPractice()">Back</button>
                </div>
                <div class="card" style="background: var(--bg-input); padding: 30px; text-align: center; margin-bottom: 20px;">
                    <div style="color: var(--text-secondary); margin-bottom: 5px;">Hit this number:</div>
                    <div style="font-family: 'Bangers', cursive; font-size: 6rem; color: var(--accent-gold);" id="rtb-target">1</div>
                    <div style="color: var(--text-secondary); margin-top: 5px;" id="rtb-progress">1 of 20</div>
                </div>
                <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 10px 20px; background: var(--bg-input); border-radius: 8px;">
                        <div style="font-family: 'Bangers', cursive; font-size: 2rem; color: var(--accent-gold);" id="rtb-darts">0</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Darts Thrown</div>
                    </div>
                    <div style="text-align: center; padding: 10px 20px; background: var(--bg-input); border-radius: 8px;">
                        <div style="font-family: 'Bangers', cursive; font-size: 2rem; color: var(--accent-green);" id="rtb-time">0:00</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Time</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <button class="btn" onclick="rtbHit()">‚úÖ HIT</button>
                    <button class="btn btn-secondary" onclick="rtbMiss()">‚ùå MISS</button>
                </div>
                <button class="btn btn-secondary" style="margin-top: 15px;" onclick="resetRTB()">Restart</button>
                <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;" id="rtb-board"></div>
            </div>

            <!-- VS Computer -->
            <div id="practice-cpu" class="card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>ü§ñ VS Computer</h3>
                    <button class="btn btn-secondary" style="width: auto; padding: 8px 16px;" onclick="endPractice()">Back</button>
                </div>
                <!-- CPU Setup -->
                <div id="cpu-setup">
                    <div class="form-group">
                        <label>Game Mode</label>
                        <div class="grid">
                            <div class="sport-btn selected" id="cpu-mode-501" onclick="selectCpuMode(501)">501</div>
                            <div class="sport-btn" id="cpu-mode-301" onclick="selectCpuMode(301)">301</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Difficulty Level</label>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                            <button class="sport-btn" onclick="selectCpuLevel(1)" id="cpu-lvl-1" style="padding: 10px;">1<br><span style="font-size: 0.65rem; color: var(--text-secondary);">Pub<br>Avg ~20</span></button>
                            <button class="sport-btn" onclick="selectCpuLevel(2)" id="cpu-lvl-2" style="padding: 10px;">2<br><span style="font-size: 0.65rem; color: var(--text-secondary);">Casual<br>Avg ~30</span></button>
                            <button class="sport-btn" onclick="selectCpuLevel(3)" id="cpu-lvl-3" style="padding: 10px;">3<br><span style="font-size: 0.65rem; color: var(--text-secondary);">Regular<br>Avg ~40</span></button>
                            <button class="sport-btn" onclick="selectCpuLevel(4)" id="cpu-lvl-4" style="padding: 10px;">4<br><span style="font-size: 0.65rem; color: var(--text-secondary);">Decent<br>Avg ~50</span></button>
                            <button class="sport-btn selected" onclick="selectCpuLevel(5)" id="cpu-lvl-5" style="padding: 10px;">5<br><span style="font-size: 0.65rem; color: var(--text-secondary);">Good<br>Avg ~60</span></button>
                            <button class="sport-btn" onclick="selectCpuLevel(6)" id="cpu-lvl-6" style="padding: 10px;">6<br><span style="font-size: 0.65rem; color: var(--text-secondary);">Strong<br>Avg ~70</span></button>
                            <button class="sport-btn" onclick="selectCpuLevel(7)" id="cpu-lvl-7" style="padding: 10px;">7<br><span style="font-size: 0.65rem; color: var(--text-secondary);">County<br>Avg ~80</span></button>
                            <button class="sport-btn" onclick="selectCpuLevel(8)" id="cpu-lvl-8" style="padding: 10px;">8<br><span style="font-size: 0.65rem; color: var(--text-secondary);">Semi-Pro<br>Avg ~90</span></button>
                            <button class="sport-btn" onclick="selectCpuLevel(9)" id="cpu-lvl-9" style="padding: 10px;">9<br><span style="font-size: 0.65rem; color: var(--text-secondary);">Pro<br>Avg ~100</span></button>
                            <button class="sport-btn" onclick="selectCpuLevel(10)" id="cpu-lvl-10" style="padding: 10px;">10<br><span style="font-size: 0.65rem; color: var(--text-secondary);">Legend<br>Avg ~110</span></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Best of</label>
                        <div class="grid">
                            <div class="sport-btn selected" id="cpu-legs-1" onclick="selectCpuLegs(1)">1 Leg</div>
                            <div class="sport-btn" id="cpu-legs-3" onclick="selectCpuLegs(3)">Best of 3</div>
                            <div class="sport-btn" id="cpu-legs-5" onclick="selectCpuLegs(5)">Best of 5</div>
                        </div>
                    </div>
                    <button class="btn" onclick="startCpuGame()">Play Computer</button>
                </div>
                <!-- CPU Active Game -->
                <div id="cpu-active" class="hidden">
                    <div style="text-align: center; margin-bottom: 10px; color: var(--text-secondary); font-size: 0.9rem;" id="cpu-game-info">501 ‚Äî Level 5 (Good)</div>
                    <div class="grid" style="margin-bottom: 15px;">
                        <div class="card" id="cpu-player-card" style="background: var(--bg-input); padding: 20px; text-align: center; border: 3px solid var(--accent-gold);">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">You</div>
                            <div style="font-family: 'Bangers', cursive; font-size: 3rem; color: var(--accent-gold);" id="cpu-p-score">501</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                Avg: <span id="cpu-p-avg">0.00</span> | Legs: <span id="cpu-p-legs">0</span>
                            </div>
                            <div id="cpu-p-checkout" style="margin-top: 8px; padding: 6px; background: var(--bg-main); border-radius: 8px; font-size: 0.85rem; min-height: 30px;"></div>
                        </div>
                        <div class="card" id="cpu-bot-card" style="background: var(--bg-input); padding: 20px; text-align: center; border: 3px solid transparent;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">ü§ñ Computer</div>
                            <div style="font-family: 'Bangers', cursive; font-size: 3rem; color: var(--accent-gold);" id="cpu-c-score">501</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                Avg: <span id="cpu-c-avg">0.00</span> | Legs: <span id="cpu-c-legs">0</span>
                            </div>
                            <div id="cpu-c-checkout" style="margin-top: 8px; padding: 6px; background: var(--bg-main); border-radius: 8px; font-size: 0.85rem; min-height: 30px;"></div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-bottom: 15px; font-weight: 600; color: var(--accent-gold);" id="cpu-turn-info">Your turn</div>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 15px;">
                        <button class="btn btn-secondary" onclick="cpuQuickScore(26)">26</button>
                        <button class="btn btn-secondary" onclick="cpuQuickScore(41)">41</button>
                        <button class="btn btn-secondary" onclick="cpuQuickScore(45)">45</button>
                        <button class="btn btn-secondary" onclick="cpuQuickScore(60)">60</button>
                        <button class="btn btn-secondary" onclick="cpuQuickScore(81)">81</button>
                        <button class="btn btn-secondary" onclick="cpuQuickScore(85)">85</button>
                        <button class="btn btn-secondary" onclick="cpuQuickScore(100)">100</button>
                        <button class="btn btn-secondary" onclick="cpuQuickScore(140)">140</button>
                        <button class="btn btn-secondary" onclick="cpuQuickScore(180)">180</button>
                        <button class="btn btn-secondary" onclick="cpuQuickScore(0)">0</button>
                    </div>
                    <div class="form-group">
                        <input type="number" id="cpu-custom-score" min="0" max="180" placeholder="Custom score (0-180)">
                    </div>
                    <button class="btn" onclick="submitCpuScore()">Submit Score</button>
                    <div class="card" style="margin-top: 15px; max-height: 150px; overflow-y: auto; background: var(--bg-input);">
                        <h4 style="margin-bottom: 10px;">Match Log</h4>
                        <div id="cpu-match-log"></div>
                    </div>
                </div>
            </div>

            <!-- Practice Session History -->
            <div id="practice-history-panel" class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>üìä Practice History</h3>
                    <div style="display: flex; gap: 8px;">
                        <select id="practice-history-filter" onchange="renderPracticeHistory()" style="padding: 6px 10px; border-radius: 8px; background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border); font-size: 0.85rem;">
                            <option value="all">All Modes</option>
                            <option value="solo">Solo Scoring</option>
                            <option value="checkout">Checkout</option>
                            <option value="rtb">Round the Board</option>
                            <option value="cpu">VS Computer</option>
                        </select>
                        <button class="btn btn-secondary" style="width: auto; padding: 6px 12px; font-size: 0.8rem;" onclick="clearPracticeHistory()">Clear</button>
                    </div>
                </div>
                <div id="practice-history-list" style="max-height: 400px; overflow-y: auto;">
                    <div style="color: var(--text-secondary); text-align: center; padding: 20px;">No practice sessions yet. Get practising!</div>
                </div>
                <div id="practice-summary" style="margin-top: 15px; padding: 15px; background: var(--bg-input); border-radius: 8px; display: none;">
                    <h4 style="margin-bottom: 10px;">Practice Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;" id="practice-summary-stats"></div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div id="leaderboard" class="section">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Overall Leaderboard</h2>
                <ul class="leaderboard" id="overall-leaderboard"></ul>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px;">Sport Leaderboards</h2>
                <div class="form-group">
                    <select id="sport-filter" onchange="updateSportLeaderboard()">
                        <option value="">Select a sport</option>
                    </select>
                </div>
                <ul class="leaderboard" id="sport-leaderboard"></ul>
            </div>
        </div>

        <!-- History Section -->
        <div id="history" class="section">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Game History</h2>
                <div class="form-group">
                    <select id="history-sport-filter" onchange="updateHistory()">
                        <option value="all">All Sports</option>
                    </select>
                </div>
                <ul class="game-history" id="game-history-list"></ul>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Settings</h2>
                
                <div class="form-group">
                    <label>Your Profile</label>
                    <div style="padding: 15px; background: var(--bg-input); border-radius: 8px;">
                        <div style="margin-bottom: 10px;">
                            <input type="text" id="edit-user-name" placeholder="Name" style="margin-bottom: 8px;">
                            <input type="email" id="edit-user-email" placeholder="Email">
                        </div>
                        <button class="btn" onclick="updateCurrentProfile()">Update Profile</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Notifications</label>
                    <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--bg-input); border-radius: 8px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 5px;">Game Reminders</div>
                            <div style="color: var(--text-secondary); font-size: 0.85rem;">Get notified when friends record games</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="notifications-toggle" onchange="toggleNotifications()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Group Code</label>
                    <div style="padding: 15px; background: var(--bg-input); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 5px;">Current Group: <span id="current-group-display" style="color: var(--accent-gold); letter-spacing: 1px;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">All your mates need this same code to see shared data</div>
                            </div>
                            <button class="btn btn-secondary" style="width: auto; padding: 6px 12px; font-size: 0.85rem;" onclick="toggleGroupCodeDisplay()">Show</button>
                        </div>
                        <button class="btn btn-secondary" onclick="changeGroupCode()">Switch Group</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Manage Sports</label>
                    <div id="sports-list"></div>
                </div>

                <!-- Install App -->
                <div class="form-group">
                    <label>Install App</label>
                    <div style="padding: 15px; background: var(--bg-input); border-radius: 8px;">
                        <button id="pwa-install-btn" class="btn hidden" onclick="installPWA()" style="width: 100%; margin-bottom: 10px; background: linear-gradient(135deg, var(--accent-gold), var(--accent-orange)); color: #1a1a2e; font-weight: 700;">
                            üì≤ Install Champion of Champions
                        </button>
                        <div id="pwa-ios-instructions" style="display: none;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: var(--accent-gold);">üì± Install on iPhone</div>
                            <ol style="color: var(--text-secondary); font-size: 0.85rem; padding-left: 20px; line-height: 1.8; margin: 0;">
                                <li>Tap the <strong style="color: var(--text-primary);">Share</strong> button (square with arrow) in Safari</li>
                                <li>Scroll down and tap <strong style="color: var(--text-primary);">Add to Home Screen</strong></li>
                                <li>Tap <strong style="color: var(--text-primary);">Add</strong> ‚Äî done! üéâ</li>
                            </ol>
                        </div>
                        <div id="pwa-android-instructions" style="display: none;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: var(--accent-gold);">üì± Install on Android</div>
                            <ol style="color: var(--text-secondary); font-size: 0.85rem; padding-left: 20px; line-height: 1.8; margin: 0;">
                                <li>Tap the <strong style="color: var(--text-primary);">‚ãÆ menu</strong> (three dots) in Chrome</li>
                                <li>Tap <strong style="color: var(--text-primary);">Add to Home screen</strong> or <strong style="color: var(--text-primary);">Install app</strong></li>
                                <li>Tap <strong style="color: var(--text-primary);">Install</strong> ‚Äî done! üéâ</li>
                            </ol>
                        </div>
                        <div id="pwa-installed-msg" style="display: none; text-align: center; color: var(--accent-green); font-weight: 600;">
                            ‚úÖ App installed! You're all set.
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="if(confirm('Are you sure? This will delete ALL data!')) clearAllData()">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="rules-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRules()">&times;</span>
            <h2 id="rules-title" style="margin-bottom: 20px; color: var(--accent-gold);"></h2>
            <div id="rules-content"></div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDPcCZMfH10dtXpAGlDikDuYnsNhm0d_Vs",
            authDomain: "champion-of-champions.firebaseapp.com",
            projectId: "champion-of-champions",
            storageBucket: "champion-of-champions.firebasestorage.app",
            messagingSenderId: "373049286870",
            appId: "1:373049286870:web:b7a6f980ff1a56e8692977"
        };
        // ================================================================

        // Initialize Firebase
        let db;
        let groupCode = localStorage.getItem('champGroupCode') || null;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('‚úÖ Firebase initialized successfully!');
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            alert('Firebase not configured yet. Please add your Firebase config to the file. See FIREBASE_SETUP.md for instructions.');
        }

        // Group code functions
        function getCollectionPath() {
            return `groups/${groupCode}/data`;
        }

        function toggleCodeVisibility() {
            const input = document.getElementById('group-code-input');
            input.type = document.getElementById('show-code-toggle').checked ? 'text' : 'password';
        }

        function submitGroupCode() {
            const code = document.getElementById('group-code-input').value.trim();
            if (code.length < 6) {
                alert('Group code must be at least 6 characters');
                return;
            }
            groupCode = code;
            localStorage.setItem('champGroupCode', code);
            
            // Verify Firebase connection with this group code
            verifyAndConnect();
        }

        async function verifyAndConnect() {
            const testPath = getCollectionPath();
            
            try {
                // Write a test value and read it back
                await db.collection(testPath).doc('_ping').set({ test: true, time: new Date().toISOString() });
                const readBack = await db.collection(testPath).doc('_ping').get();
                
                if (readBack.exists) {
                    document.getElementById('firebase-status').innerHTML = 'üü¢ Connected to Firebase';
                    document.getElementById('firebase-status').style.color = 'var(--accent-green)';
                } else {
                    console.error('‚ùå Firebase write succeeded but read failed');
                    document.getElementById('firebase-status').innerHTML = 'üü° Firebase issue ‚Äî check console';
                    document.getElementById('firebase-status').style.color = 'var(--accent-orange)';
                }
            } catch (err) {
                console.error('‚ùå Firebase connection test failed:', err.code, err.message);
                console.error('Path attempted:', testPath);
                if (err.code === 'permission-denied') {
                    document.getElementById('firebase-status').innerHTML = 'üî¥ Permission denied ‚Äî update Firestore rules';
                    document.getElementById('firebase-status').style.color = 'var(--accent-orange)';
                    alert('Firebase permission denied!\n\nYour Firestore rules need to allow access to:\n' + testPath + '\n\nUpdate your rules to:\nmatch /groups/{groupCode}/data/{document} {\n  allow read, write: if true;\n}');
                } else {
                    document.getElementById('firebase-status').innerHTML = 'üî¥ Firebase error ‚Äî check console';
                    document.getElementById('firebase-status').style.color = 'var(--accent-orange)';
                }
            }

            // Show login screen
            document.getElementById('group-code-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            
            // Load data for this group
            await loadData();
        }

        function changeGroupCode() {
            if (!confirm('Switch group? You\'ll be logged out and need to enter a new group code.')) return;
            localStorage.removeItem('champGroupCode');
            groupCode = null;
            state.currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('group-code-screen').classList.remove('hidden');
            document.getElementById('group-code-input').value = '';
        }

        let groupCodeVisible = false;
        function toggleGroupCodeDisplay() {
            groupCodeVisible = !groupCodeVisible;
            const display = document.getElementById('current-group-display');
            if (groupCodeVisible && groupCode) {
                display.textContent = groupCode;
            } else {
                display.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
        }

        // If group code already saved, skip the code screen
        if (groupCode) {
            document.getElementById('group-code-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        // Firebase helper functions (replaces window.storage)
        const firebaseStorage = {
            async get(key) {
                if (!db || !groupCode) { console.warn('Firebase or group code not ready'); return null; }
                try {
                    const doc = await db.collection(getCollectionPath()).doc(key).get();
                    if (doc.exists) {
                        return { value: doc.data().value };
                    }
                    return null;
                } catch (error) {
                    console.error('Firebase get error:', error);
                    return null;
                }
            },
            async set(key, value) {
                if (!db || !groupCode) { console.error('‚ùå Firebase or group code not ready ‚Äî db:', !!db, 'groupCode:', groupCode); throw new Error('Firebase not ready'); }
                const path = getCollectionPath();
                await db.collection(path).doc(key).set({ value: value, updatedAt: new Date().toISOString() });
                console.log(`‚úÖ Written: ${path}/${key}`);
                return true;
            },
            async delete(key) {
                if (!db || !groupCode) { console.warn('Firebase or group code not ready'); return false; }
                try {
                    await db.collection(getCollectionPath()).doc(key).delete();
                    return true;
                } catch (error) {
                    console.error('Firebase delete error:', error);
                    return false;
                }
            }
        };

        // State management
        let state = {
            sports: ['Darts', 'Pool-US', 'Pool-UK', 'Badminton', 'Poker'],
            games: [],
            practiceHistory: [],
            selectedSport: 'Darts',
            gameType: 'singles',
            team1Players: [],
            team2Players: [],
            profiles: [],
            currentUser: null,
            notifications: false,
            pokerSession: {
                buyIn: 0,
                players: []
            }
        };

        // Sport rules database
        const sportRules = {
            'Darts': {
                title: 'Darts Rules (501/301)',
                content: `
                    <ul style="line-height: 1.8;">
                        <li><strong>Starting Score:</strong> Players start at 501 or 301 points</li>
                        <li><strong>Objective:</strong> Reduce your score to exactly zero</li>
                        <li><strong>Finishing:</strong> Must finish on a double (outer ring)</li>
                        <li><strong>Bust:</strong> Going below zero or landing on 1 - no score deducted, turn ends</li>
                        <li><strong>Legs:</strong> First to win the agreed number of legs wins the match</li>
                        <li><strong>Scoring:</strong> Outer ring = Double, Inner ring = Triple, Center = Bullseye (50)</li>
                    </ul>
                `
            },
            'Pool-US': {
                title: '8-Ball Pool (US Rules)',
                content: `
                    <ul style="line-height: 1.8;">
                        <li><strong>Objective:</strong> Pocket all your balls (solids 1-7 or stripes 9-15) then the 8-ball</li>
                        <li><strong>Break:</strong> Must hit the rack and either pocket a ball or hit 4 balls to the rails</li>
                        <li><strong>Table Assignment:</strong> Determined by first legally pocketed ball after the break</li>
                        <li><strong>Call Shot:</strong> The 8-ball must be called (pocket and ball)</li>
                        <li><strong>Fouls:</strong> Scratch, not hitting your ball first, or no rail contact</li>
                        <li><strong>Winning:</strong> Legally pocket the 8-ball after all your balls</li>
                        <li><strong>Loss:</strong> Pocket 8-ball early, scratch on 8-ball, or knock 8-ball off table</li>
                    </ul>
                `
            },
            'Pool-UK': {
                title: '8-Ball Pool (UK Rules / Blackball)',
                content: `
                    <ul style="line-height: 1.8;">
                        <li><strong>Balls:</strong> Reds and yellows (not stripes/solids)</li>
                        <li><strong>Open Table:</strong> After break, table stays open until a legal pot</li>
                        <li><strong>Nominating:</strong> Must nominate ball and pocket for 8-ball only</li>
                        <li><strong>Two Visits:</strong> After foul, opponent gets two visits (can continue after potting)</li>
                        <li><strong>Total Snooker:</strong> If completely snookered after foul, ball in hand anywhere</li>
                        <li><strong>8-Ball Last:</strong> Must pot all your colors before attempting the 8-ball</li>
                        <li><strong>Loss:</strong> Foul on 8-ball, pot 8-ball early, or pot 8-ball and opponent's ball together</li>
                    </ul>
                `
            },
            'Badminton': {
                title: 'Badminton Rules',
                content: `
                    <ul style="line-height: 1.8;">
                        <li><strong>Scoring:</strong> Rally point system - point scored on every serve</li>
                        <li><strong>Winning:</strong> First to 21 points wins a game</li>
                        <li><strong>Match:</strong> Best of 3 games</li>
                        <li><strong>Deuce:</strong> At 20-all, game continues until a 2-point lead is achieved</li>
                        <li><strong>Service:</strong> Serve diagonally, underhand below waist height</li>
                        <li><strong>Singles Court:</strong> Long and narrow service courts</li>
                        <li><strong>Doubles Court:</strong> Wider service courts, shorter service length</li>
                    </ul>
                `
            },
            'Poker': {
                title: 'Champion of Champions ‚Äî Poker Rules',
                content: `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: var(--accent-gold);">Founding Members:</strong> James Purtell, Jacob Spyer, Freddie Spyer, Oliver Clinch, Jack Posmore, Tom Bunce
                    </div>
                    <p style="font-style: italic; color: var(--text-secondary); margin-bottom: 15px;">The book of rules is the law and all motions shall be updated in the app for the following session.</p>
                    <ol style="line-height: 2; padding-left: 20px;">
                        <li>If you leave before the end, chips are discarded (not given to any living being)</li>
                        <li>At the end of the evening a new date is set for the next match</li>
                        <li>Min buy in is ¬£10. Buy ins then follow on the original amount</li>
                        <li>Texas Hold'em will be the Poker game for the first game</li>
                        <li>Over the course of the year wins will be documented ‚Äî the winner will receive a cup bought by the Founding Members</li>
                        <li>Upon sitting at the table all players must consume 1 shot of limoncello üçã</li>
                        <li>Buy in consists of: 3√ó1000 (Orange), 4√ó500 (Purple), 7√ó100 (Black), 5√ó50 (Blue), 5√ó25 (Green)</li>
                        <li>NO COINS</li>
                        <li>10:00 ‚Äî Last buy ins, however this can be changed by the host</li>
                        <li>No Consoling</li>
                        <li>A Host can decide upon attire for the evening</li>
                        <li>To create a new rule there must be a majority Vote & Motion to commit the rule</li>
                        <li>No Trading of Coins for favours</li>
                        <li>Suits on the last game</li>
                        <li>Air BNB last game / where the first game hosted</li>
                        <li>First blind stage consists of 10 games, 11th game double the blind, 3√ó rounds then double again</li>
                    </ol>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                        <strong style="color: var(--accent-gold);">Additional Rules:</strong>
                        <ul style="line-height: 2; padding-left: 20px; margin-top: 8px;">
                            <li>No consulting</li>
                            <li>2 decks per game</li>
                            <li>To become a founder you have to win</li>
                            <li>No motions during a round</li>
                            <li>When a rule is broken ‚Äî punishment is a shot ü•É</li>
                            <li>No more than 3 min between rounds ‚Äî if more, a shot is owed</li>
                            <li>If anyone is proposed to trial a new game and it is majority voted in, it will be done at the next poker night</li>
                            <li>Once we get to 20:00, increments are 200</li>
                        </ul>
                    </div>
                `
            }
        };

        // Darts game state
        let dartsGame = {
            active: false,
            mode: 501,
            legsToWin: 1,
            player1: { name: '', score: 501, legs: 0, throws: [], totalScore: 0, darts: 0 },
            player2: { name: '', score: 501, legs: 0, throws: [], totalScore: 0, darts: 0 },
            currentPlayer: 1,
            history: []
        };

        // Load data from storage on startup
        async function loadData() {
            try {
                const sportsData = await firebaseStorage.get('sports');
                const gamesData = await firebaseStorage.get('games');
                const profilesData = await firebaseStorage.get('profiles');
                const currentUserData = await firebaseStorage.get('currentUser');
                const notificationsData = await firebaseStorage.get('notifications');
                const practiceData = await firebaseStorage.get('practiceHistory');
                
                
                if (sportsData) state.sports = JSON.parse(sportsData.value);
                if (gamesData) state.games = JSON.parse(gamesData.value);
                if (profilesData) state.profiles = JSON.parse(profilesData.value);
                if (practiceData) state.practiceHistory = JSON.parse(practiceData.value);
                if (notificationsData) {
                    state.notifications = JSON.parse(notificationsData.value);
                    document.getElementById('notifications-toggle').checked = state.notifications;
                }
                
                
                // Update profile select dropdown
                updateProfileSelect();
                
                // If user was logged in, auto-login
                if (currentUserData) {
                    const userName = JSON.parse(currentUserData.value);
                    const user = state.profiles.find(p => p.name === userName);
                    if (user) {
                        state.currentUser = user;
                        showMainApp();
                    } else {
                    }
                }
                
                updateUI();
                renderPracticeHistory();
            } catch (error) {
                console.error('‚ùå loadData error:', error);
                updateUI();
                renderPracticeHistory();
            }
        }

        // Save data to storage
        async function saveData() {
            try {
                await firebaseStorage.set('sports', JSON.stringify(state.sports));
                await firebaseStorage.set('games', JSON.stringify(state.games));
                await firebaseStorage.set('profiles', JSON.stringify(state.profiles));
                if (state.currentUser) {
                    await firebaseStorage.set('currentUser', JSON.stringify(state.currentUser.name));
                }
                await firebaseStorage.set('notifications', JSON.stringify(state.notifications));
                console.log('‚úÖ Data saved successfully to Firebase');
            } catch (error) {
                console.error('‚ùå Error saving data:', error);
                console.error('‚ùå Error code:', error.code);
                console.error('‚ùå Error message:', error.message);
                if (error.message && error.message.includes('not ready')) {
                    alert('Firebase is not connected. Please check your Firebase config and group code.');
                } else if (error.code === 'permission-denied') {
                    alert('Firebase permission denied!\n\nYour Firestore rules are blocking writes to:\n' + getCollectionPath() + '\n\nPlease update your Firestore rules.');
                } else {
                    alert('Error saving data: ' + (error.message || error) + '\nCheck browser console (F12) for details.');
                }
            }
        }

        // Save practice data separately ‚Äî never touches games/leaderboards
        async function savePracticeData() {
            try {
                await firebaseStorage.set('practiceHistory', JSON.stringify(state.practiceHistory));
            } catch (error) {
                console.error('Error saving practice data:', error);
            }
        }

        // Profile and Login Management
        function updateProfileSelect() {
            const select = document.getElementById('profile-select');
            select.innerHTML = '<option value="">-- Choose Profile --</option>' +
                state.profiles.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        }

        function showCreateProfile() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('create-profile-form').classList.remove('hidden');
        }

        function cancelCreateProfile() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('create-profile-form').classList.add('hidden');
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-email').value = '';
        }

        async function createProfile() {
            const name = document.getElementById('new-user-name').value.trim();
            const email = document.getElementById('new-user-email').value.trim();

            if (!name) {
                alert('Please enter your name');
                return;
            }

            if (state.profiles.find(p => p.name === name)) {
                alert('A profile with this name already exists');
                return;
            }

            const newProfile = {
                name: name,
                email: email,
                createdAt: new Date().toISOString()
            };

            state.profiles.push(newProfile);
            state.currentUser = newProfile;
            await saveData();
            updateProfileSelect();
            showMainApp();
        }

        async function loginUser() {
            const selectElement = document.getElementById('profile-select');
            const userName = selectElement.value;

            if (!userName) {
                alert('Please select a profile');
                return;
            }

            const user = state.profiles.find(p => p.name === userName);
            if (user) {
                state.currentUser = user;
                await saveData();
                showMainApp();
            }
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // Update current user display
            document.getElementById('current-user-name').textContent = state.currentUser.name;
            document.getElementById('current-user-email').textContent = state.currentUser.email || 'No email set';
            
            updateUserStats();
            updateProfileDatalist();
            renderPokerProfileButtons();
        }

        async function logoutUser() {
            if (confirm('Are you sure you want to logout?')) {
                state.currentUser = null;
                try {
                    await firebaseStorage.delete('currentUser');
                } catch (error) {
                    console.log('Error clearing current user');
                }
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }
        }

        function updateUserStats() {
            if (!state.currentUser) return;

            const userName = state.currentUser.name;
            const allStats = calculatePlayerStats();
            const userStats = allStats[userName] || { points: 0, wins: 0, draws: 0, losses: 0, games: 0 };

            document.getElementById('user-total-points').textContent = userStats.points;
            document.getElementById('user-total-wins').textContent = userStats.wins;
            document.getElementById('user-total-games').textContent = userStats.games;
            
            const winRate = userStats.games > 0 ? ((userStats.wins / userStats.games) * 100).toFixed(1) : 0;
            document.getElementById('user-win-rate').textContent = winRate + '%';

            // Calculate sport-specific stats
            updateSportAverages();
        }

        function updateSportAverages() {
            if (!state.currentUser) return;

            const userName = state.currentUser.name;
            const sportStats = {};

            // Initialize sport stats
            state.sports.forEach(sport => {
                sportStats[sport] = { games: 0, wins: 0, points: 0 };
            });

            // Calculate stats per sport
            state.games.forEach(game => {
                const sport = game.sport;
                
                if (game.sport === 'Poker' && game.players) {
                    const playerData = game.players.find(p => p.name === userName);
                    if (playerData) {
                        sportStats[sport].games++;
                        if (playerData.placementPoints !== undefined) {
                            sportStats[sport].points += playerData.placementPoints;
                            if (playerData.placement === 1) sportStats[sport].wins++;
                        } else {
                            if (game.winner === userName) sportStats[sport].wins++;
                            sportStats[sport].points += (playerData.profitLoss || 0);
                        }
                    }
                } else if (game.gameType === 'singles') {
                    if (game.player1 === userName || game.player2 === userName) {
                        sportStats[sport].games++;
                        if (game.winner === userName) {
                            sportStats[sport].wins++;
                            sportStats[sport].points += 3;
                        } else if (game.winner === 'Draw') {
                            sportStats[sport].points += 1;
                        }
                    }
                } else if (game.gameType === 'teams') {
                    const team1 = game.player1.split(', ');
                    const team2 = game.player2.split(', ');
                    
                    if (team1.includes(userName) || team2.includes(userName)) {
                        sportStats[sport].games++;
                        const isTeam1 = team1.includes(userName);
                        const teamWon = isTeam1 ? game.winner === game.player1 : game.winner === game.player2;
                        
                        if (game.winner === 'Draw') {
                            sportStats[sport].points += 1;
                        } else if (teamWon) {
                            sportStats[sport].wins++;
                            sportStats[sport].points += 3;
                        }
                    }
                }
            });

            // Display sport averages
            const container = document.getElementById('user-sport-averages');
            const activeSports = state.sports.filter(sport => sportStats[sport].games > 0);

            if (activeSports.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No games played yet. Start recording games to see your stats!</div>';
                return;
            }

            container.innerHTML = activeSports.map(sport => {
                const stats = sportStats[sport];
                const winRate = stats.games > 0 ? ((stats.wins / stats.games) * 100).toFixed(1) : 0;
                const isPokker = sport === 'Poker';
                
                return `
                    <div style="padding: 15px; background: var(--bg-input); border-radius: 12px; border: 2px solid var(--border);">
                        <div style="font-weight: 700; margin-bottom: 10px; color: var(--accent-gold);">${sport}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
                            Games: ${stats.games}<br>
                            Wins: ${stats.wins}<br>
                            Win Rate: ${winRate}%<br>
                            ${isPokker ? `Profit/Loss: ¬£${stats.points.toFixed(2)}` : `Points: ${stats.points}`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Rules modal functions
        function showRules(sport) {
            const modal = document.getElementById('rules-modal');
            const rules = sportRules[sport];
            
            if (rules) {
                document.getElementById('rules-title').textContent = rules.title;
                document.getElementById('rules-content').innerHTML = rules.content;
                modal.style.display = 'block';
            }
        }

        function closeRules() {
            document.getElementById('rules-modal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('rules-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Notifications toggle
        async function toggleNotifications() {
            state.notifications = document.getElementById('notifications-toggle').checked;
            await saveData();
            
            if (state.notifications) {
                alert('Notifications enabled! You\'ll receive updates when friends record games.');
            }
        }

        async function updateCurrentProfile() {
            if (!state.currentUser) return;

            const name = document.getElementById('edit-user-name').value.trim();
            const email = document.getElementById('edit-user-email').value.trim();

            if (!name) {
                alert('Please enter your name');
                return;
            }

            // Update profile in profiles array
            const profileIndex = state.profiles.findIndex(p => p.name === state.currentUser.name);
            
            if (profileIndex !== -1) {
                state.profiles[profileIndex].name = name;
                state.profiles[profileIndex].email = email;
                state.currentUser = state.profiles[profileIndex];
                await saveData();
                showMainApp();
                alert('Profile updated successfully!');
            }
        }

        // Load current profile data into settings when opening settings tab
        function loadProfileInSettings() {
            if (!state.currentUser) return;

            document.getElementById('edit-user-name').value = state.currentUser.name;
            document.getElementById('edit-user-email').value = state.currentUser.email || '';
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                
                if (tab.dataset.tab === 'leaderboard') {
                    updateLeaderboards();
                } else if (tab.dataset.tab === 'history') {
                    updateHistory();
                } else if (tab.dataset.tab === 'settings') {
                    loadProfileInSettings();
                }
                
                // Update user stats when viewing any tab
                updateUserStats();
            });
        });

        // Sport selection
        document.querySelectorAll('.sport-btn[data-sport]').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.dataset.sport === 'Custom') {
                    document.getElementById('custom-sport-input').classList.remove('hidden');
                    return;
                }
                
                document.querySelectorAll('.sport-btn[data-sport]').forEach(b => {
                    if (b !== btn) b.classList.remove('selected');
                });
                btn.classList.add('selected');
                state.selectedSport = btn.dataset.sport;
                
                // Show/hide appropriate scoring sections
                const dartsScoring = document.getElementById('darts-scoring');
                const pokerScoring = document.getElementById('poker-scoring');
                const regularScoring = document.getElementById('regular-scoring');
                const saveBtn = document.getElementById('save-game-btn');
                
                // Hide all first
                dartsScoring.classList.add('hidden');
                pokerScoring.classList.add('hidden');
                regularScoring.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                // Default: show game type and players
                document.getElementById('game-type-section').classList.remove('hidden');
                selectGameType(state.gameType);
                
                if (state.selectedSport === 'Darts') {
                    dartsScoring.classList.remove('hidden');
                    saveBtn.classList.add('hidden');
                    // Make sure we're in setup mode if no game is active
                    if (!dartsGame.active) {
                        document.getElementById('darts-setup').classList.remove('hidden');
                        document.getElementById('darts-game').classList.add('hidden');
                    }
                    // End any active darts game when switching sports
                    if (dartsGame.active) {
                        if (confirm('Switching sports will end the current darts game. Continue?')) {
                            endDartsGame();
                        } else {
                            // Revert selection
                            btn.classList.remove('selected');
                            document.querySelector('.sport-btn[data-sport="Darts"]').classList.add('selected');
                            state.selectedSport = 'Darts';
                            return;
                        }
                    }
                } else if (state.selectedSport === 'Poker') {
                    pokerScoring.classList.remove('hidden');
                    saveBtn.classList.add('hidden');
                    // Hide game type and player sections ‚Äî poker handles its own players
                    document.getElementById('game-type-section').classList.add('hidden');
                    document.getElementById('players-section').classList.add('hidden');
                    document.getElementById('teams-section').classList.add('hidden');
                    renderPokerProfileButtons();
                } else {
                    regularScoring.classList.remove('hidden');
                }
                
                document.getElementById('custom-sport-input').classList.add('hidden');
            });
        });

        async function addCustomSport() {
            const sportName = document.getElementById('new-sport-name').value.trim();
            if (!sportName) {
                alert('Please enter a sport name');
                return;
            }
            
            if (state.sports.includes(sportName)) {
                alert('This sport already exists');
                return;
            }
            
            state.sports.push(sportName);
            await saveData();
            
            // Add button for new sport
            const customBtn = document.querySelector('.sport-btn[data-sport="Custom"]');
            const newBtn = document.createElement('div');
            newBtn.className = 'sport-btn';
            newBtn.dataset.sport = sportName;
            newBtn.textContent = `‚ö° ${sportName}`;
            customBtn.parentNode.insertBefore(newBtn, customBtn);
            
            // Add event listener
            newBtn.addEventListener('click', () => {
                document.querySelectorAll('.sport-btn[data-sport]').forEach(b => {
                    if (b !== newBtn) b.classList.remove('selected');
                });
                newBtn.classList.add('selected');
                state.selectedSport = sportName;
                document.getElementById('darts-scoring').classList.add('hidden');
                document.getElementById('regular-scoring').classList.remove('hidden');
                document.getElementById('custom-sport-input').classList.add('hidden');
            });
            
            document.getElementById('new-sport-name').value = '';
            document.getElementById('custom-sport-input').classList.add('hidden');
            updateUI();
        }

        function selectGameType(type) {
            state.gameType = type;
            document.getElementById('singles-btn').classList.toggle('selected', type === 'singles');
            document.getElementById('teams-btn').classList.toggle('selected', type === 'teams');
            document.getElementById('players-section').classList.toggle('hidden', type === 'teams');
            document.getElementById('teams-section').classList.toggle('hidden', type === 'singles');
            
            // Update score labels
            const label1 = document.getElementById('score1-label');
            const label2 = document.getElementById('score2-label');
            if (type === 'teams') {
                label1.textContent = 'Team 1 Score';
                label2.textContent = 'Team 2 Score';
            } else {
                label1.textContent = 'Player 1 Score';
                label2.textContent = 'Player 2 Score';
            }
        }

        function addTeamPlayer(team) {
            const input = document.getElementById(`${team}-input`);
            const name = input.value.trim();
            
            if (!name) return;
            
            if (team === 'team1') {
                state.team1Players.push(name);
            } else {
                state.team2Players.push(name);
            }
            
            input.value = '';
            renderTeamPlayers();
        }

        function renderTeamPlayers() {
            const team1Container = document.getElementById('team1-players');
            const team2Container = document.getElementById('team2-players');
            
            team1Container.innerHTML = state.team1Players.map((p, i) => 
                `<span class="player-chip">${p} <span onclick="removeTeamPlayer('team1', ${i})" style="cursor:pointer; margin-left:5px;">√ó</span></span>`
            ).join('');
            
            team2Container.innerHTML = state.team2Players.map((p, i) => 
                `<span class="player-chip">${p} <span onclick="removeTeamPlayer('team2', ${i})" style="cursor:pointer; margin-left:5px;">√ó</span></span>`
            ).join('');
        }

        function removeTeamPlayer(team, index) {
            if (team === 'team1') {
                state.team1Players.splice(index, 1);
            } else {
                state.team2Players.splice(index, 1);
            }
            renderTeamPlayers();
        }

        // ==================== DARTS GAME FUNCTIONS ====================
        
        // Comprehensive checkout chart for darts
        function getCheckout(score) {
            const checkouts = {
                2: ["D1"],
                3: ["D1, 1"],
                4: ["D2"],
                5: ["D2, 1 or D1, 3"],
                6: ["D3"],
                7: ["D3, 1 or D2, 3"],
                8: ["D4"],
                9: ["D4, 1 or D3, 3"],
                10: ["D5"],
                11: ["D5, 1 or D4, 3"],
                12: ["D6"],
                13: ["D6, 1 or D5, 3"],
                14: ["D7"],
                15: ["D7, 1 or D6, 3"],
                16: ["D8"],
                17: ["D8, 1 or D7, 3"],
                18: ["D9"],
                19: ["D9, 1 or D8, 3"],
                20: ["D10"],
                21: ["D10, 1 or D9, 3"],
                22: ["D11"],
                23: ["D11, 1 or D10, 3"],
                24: ["D12"],
                25: ["D12, 1 or D11, 3"],
                26: ["D13"],
                27: ["D13, 1 or D12, 3"],
                28: ["D14"],
                29: ["D14, 1 or D13, 3"],
                30: ["D15"],
                31: ["D15, 1 or D14, 3"],
                32: ["D16"],
                33: ["D16, 1 or D15, 3"],
                34: ["D17"],
                35: ["D17, 1 or D16, 3"],
                36: ["D18"],
                37: ["D18, 1 or D17, 3"],
                38: ["D19"],
                39: ["D19, 1 or D18, 3"],
                40: ["D20"],
                41: ["9, D16 or 1, D20"],
                42: ["10, D16 or 6, D18"],
                43: ["11, D16 or 3, D20"],
                44: ["12, D16 or 4, D20"],
                45: ["13, D16 or 5, D20"],
                46: ["14, D16 or 6, D20"],
                47: ["15, D16 or 7, D20"],
                48: ["16, D16 or 8, D20"],
                49: ["17, D16 or 9, D20"],
                50: ["18, D16 or 10, D20 or Bull"],
                51: ["19, D16 or 11, D20"],
                52: ["20, D16 or 12, D20"],
                53: ["13, D20 or 17, D18"],
                54: ["14, D20 or 18, D18"],
                55: ["15, D20 or 19, D18"],
                56: ["16, D20 or 20, D18"],
                57: ["17, D20 or 19, D19"],
                58: ["18, D20 or 18, D20"],
                59: ["19, D20 or 17, D21"],
                60: ["20, D20"],
                61: ["T15, D8 or 25, D18"],
                62: ["T10, D16 or 10, Bull"],
                63: ["T13, D12 or 13, Bull"],
                64: ["T16, D8 or 16, Bull"],
                65: ["T11, D16 or 25, D20"],
                66: ["T10, D18 or 10, Bull"],
                67: ["T17, D8 or 17, Bull"],
                68: ["T20, D4 or 20, Bull"],
                69: ["T19, D6 or 19, Bull"],
                70: ["T18, D8 or 18, Bull"],
                71: ["T13, D16 or 13, Bull"],
                72: ["T16, D12 or 16, Bull"],
                73: ["T19, D8 or 19, Bull"],
                74: ["T14, D16 or 14, Bull"],
                75: ["T17, D12 or 17, Bull"],
                76: ["T20, D8 or 20, Bull"],
                77: ["T19, D10 or T15, D16"],
                78: ["T18, D12 or 18, Bull"],
                79: ["T19, D11 or T13, D20"],
                80: ["T20, D10 or T16, D16"],
                81: ["T19, D12 or T15, D18"],
                82: ["T14, D20 or Bull, D16"],
                83: ["T17, D16 or T13, D21"],
                84: ["T20, D12 or T16, D18"],
                85: ["T15, D20 or T19, D14"],
                86: ["T18, D16 or T14, D20"],
                87: ["T17, D18 or T13, D21"],
                88: ["T16, D20 or T20, D14"],
                89: ["T19, D16 or T15, D22"],
                90: ["T18, D18 or T20, D15"],
                91: ["T17, D20 or T13, D25"],
                92: ["T20, D16 or T16, D22"],
                93: ["T19, D18 or T17, D21"],
                94: ["T18, D20 or T14, D23"],
                95: ["T19, D19 or T15, D25"],
                96: ["T20, D18 or T16, D24"],
                97: ["T19, D20 or T17, D23"],
                98: ["T20, D19 or T16, Bull"],
                99: ["T19, D21 or T17, Bull"],
                100: ["T20, D20 or T16, D16"],
                101: ["T17, Bull or T20, D20, 1"],
                102: ["T20, D21 or T14, Bull"],
                103: ["T19, D23 or T17, D16"],
                104: ["T18, Bull or T16, D20"],
                105: ["T20, D22, 1 or T19, D24"],
                106: ["T20, D23 or T18, D16"],
                107: ["T19, Bull or T17, D18"],
                108: ["T20, D24 or T16, D20"],
                109: ["T20, D24, 1 or T19, D16"],
                110: ["T20, Bull or T18, D20"],
                111: ["T19, T12, D18 or T20, T11, D12"],
                112: ["T20, T12, D20 or T16, D20"],
                113: ["T19, T16, D11 or T20, T13, D11"],
                114: ["T20, T14, D12 or T18, D20"],
                115: ["T20, T15, D10 or T19, T18, D4"],
                116: ["T20, T16, D8 or T19, D19, 1"],
                117: ["T20, T17, D6 or T19, Bull"],
                118: ["T20, T18, D4 or T18, Bull"],
                119: ["T19, T12, D16 or T20, T19, 2"],
                120: ["T20, 20, Bull or T20, T20, D0"],
                121: ["T17, T10, Bull or T20, T11, D14"],
                122: ["T18, T18, D7 or T18, T16, D10"],
                123: ["T19, T16, D9 or T19, T10, D18"],
                124: ["T20, T16, D10 or T20, T14, D13"],
                125: ["T18, T19, D8 or T20, T15, D10"],
                126: ["T19, T19, D6 or T20, T16, D9"],
                127: ["T20, T17, D8 or T19, T10, Bull"],
                128: ["T18, T14, D16 or T20, T18, D7"],
                129: ["T19, T16, D12 or T19, T12, D18"],
                130: ["T20, T20, D5 or T20, T18, D8"],
                131: ["T19, T14, D16 or T20, T13, D16"],
                132: ["T20, T16, D12 or T20, T20, D6"],
                133: ["T20, T19, D8 or T19, T16, D11"],
                134: ["T20, T14, D16 or T20, T16, D11"],
                135: ["T20, T15, D15 or T20, T17, D12"],
                136: ["T20, T20, D8 or T20, T16, D14"],
                137: ["T20, T19, D10 or T19, T20, D10"],
                138: ["T20, T18, D12 or T20, T14, D18"],
                139: ["T20, T19, D11 or T19, T14, D20"],
                140: ["T20, T20, D10 or T19, T19, D12"],
                141: ["T20, T19, D12 or T17, T18, D15"],
                142: ["T20, T14, D20 or T20, T18, D14"],
                143: ["T20, T17, D16 or T19, T18, D14"],
                144: ["T20, T20, D12 or T20, T16, D18"],
                145: ["T20, T19, D14 or T20, T15, D20"],
                146: ["T20, T18, D16 or T19, T19, D16"],
                147: ["T20, T17, D18 or T19, T18, D15"],
                148: ["T20, T20, D14 or T20, T16, D20"],
                149: ["T20, T19, D16 or T20, T17, D19"],
                150: ["T20, T18, D18 or T20, Bull, Bull"],
                151: ["T20, T17, D20 or T17, T18, D20"],
                152: ["T20, T20, D16 or T20, T16, Bull"],
                153: ["T20, T19, D18 or T19, T18, D18"],
                154: ["T20, T18, D20 or T18, T20, D20"],
                155: ["T20, T19, D19 or T19, T16, Bull"],
                156: ["T20, T20, D18 or T20, T16, D24"],
                157: ["T20, T19, D20 or T19, T20, D20"],
                158: ["T20, T20, D19 or T18, T18, Bull"],
                159: ["T20, T19, D21 or T19, T14, Bull"],
                160: ["T20, T20, D20 or T20, T16, D16"],
                161: ["T20, T17, Bull or T19, T20, Bull"],
                162: ["T20, T20, D21 or T18, T18, D24"],
                163: ["T20, T19, D23 or T17, T18, Bull"],
                164: ["T20, T18, Bull or T20, T20, D22"],
                165: ["T20, T19, D24 or T19, T16, Bull"],
                166: ["T20, T18, Bull or T20, T20, D23"],
                167: ["T20, T19, Bull or T17, T20, D25"],
                168: ["T20, T20, D24 or T20, T16, Bull"],
                169: ["T20, T19, D25 or T19, T18, Bull"],
                170: ["T20, T20, Bull"]
            };

            if (score < 2 || score > 170) return null;
            if (score === 169 || score === 168 || score === 166 || score === 165 || 
                score === 163 || score === 162 || score === 159) {
                // These are technically possible but very difficult
                return checkouts[score] || null;
            }
            
            return checkouts[score] || null;
        }

        function updateCheckoutDisplay() {
            const p1Checkout = document.getElementById('p1-checkout');
            const p2Checkout = document.getElementById('p2-checkout');

            // Player 1 checkout
            const p1Score = dartsGame.player1.score;
            const p1Suggestion = getCheckout(p1Score);
            
            if (p1Suggestion && p1Score <= 170) {
                p1Checkout.innerHTML = `
                    <div style="color: var(--accent-green); font-weight: 700;">üéØ CHECKOUT!</div>
                    <div style="color: var(--text-primary); margin-top: 4px;">${p1Suggestion.join(' or ')}</div>
                `;
            } else if (p1Score <= 40) {
                p1Checkout.innerHTML = `<div style="color: var(--text-secondary);">Finish on double!</div>`;
            } else {
                p1Checkout.innerHTML = '';
            }

            // Player 2 checkout
            const p2Score = dartsGame.player2.score;
            const p2Suggestion = getCheckout(p2Score);
            
            if (p2Suggestion && p2Score <= 170) {
                p2Checkout.innerHTML = `
                    <div style="color: var(--accent-green); font-weight: 700;">üéØ CHECKOUT!</div>
                    <div style="color: var(--text-primary); margin-top: 4px;">${p2Suggestion.join(' or ')}</div>
                `;
            } else if (p2Score <= 40) {
                p2Checkout.innerHTML = `<div style="color: var(--text-secondary);">Finish on double!</div>`;
            } else {
                p2Checkout.innerHTML = '';
            }
        }
        
        function selectDartsMode(mode) {
            dartsGame.mode = mode;
            document.getElementById('mode-501').classList.toggle('selected', mode === 501);
            document.getElementById('mode-301').classList.toggle('selected', mode === 301);
        }

        function selectLegsToWin(legs) {
            dartsGame.legsToWin = legs;
            document.getElementById('legs-1').classList.toggle('selected', legs === 1);
            document.getElementById('legs-3').classList.toggle('selected', legs === 3);
            document.getElementById('legs-5').classList.toggle('selected', legs === 5);
        }

        function startDartsGame() {
            const p1Name = state.gameType === 'singles' 
                ? document.getElementById('player1').value.trim()
                : state.team1Players.join(', ');
            const p2Name = state.gameType === 'singles'
                ? document.getElementById('player2').value.trim()
                : state.team2Players.join(', ');

            if (!p1Name || !p2Name) {
                alert('Please enter both player names');
                return;
            }

            // Initialize game
            dartsGame.active = true;
            dartsGame.player1 = { 
                name: p1Name, 
                score: dartsGame.mode, 
                legs: 0, 
                throws: [], 
                totalScore: 0, 
                darts: 0 
            };
            dartsGame.player2 = { 
                name: p2Name, 
                score: dartsGame.mode, 
                legs: 0, 
                throws: [], 
                totalScore: 0, 
                darts: 0 
            };
            dartsGame.currentPlayer = 1;
            dartsGame.history = [];

            // Update UI
            document.getElementById('darts-setup').classList.add('hidden');
            document.getElementById('darts-game').classList.remove('hidden');
            document.getElementById('game-mode-display').textContent = `${dartsGame.mode} - Best of ${dartsGame.legsToWin}`;
            document.getElementById('p1-name-display').textContent = p1Name;
            document.getElementById('p2-name-display').textContent = p2Name;
            
            updateDartsScoreboard();
            highlightCurrentPlayer();
        }

        function updateDartsScoreboard() {
            // Update scores
            document.getElementById('p1-score-display').textContent = dartsGame.player1.score;
            document.getElementById('p2-score-display').textContent = dartsGame.player2.score;

            // Update averages
            const p1Avg = dartsGame.player1.darts > 0 
                ? (dartsGame.player1.totalScore / (dartsGame.player1.darts / 3)).toFixed(2)
                : '0.00';
            const p2Avg = dartsGame.player2.darts > 0 
                ? (dartsGame.player2.totalScore / (dartsGame.player2.darts / 3)).toFixed(2)
                : '0.00';

            document.getElementById('p1-avg-display').textContent = p1Avg;
            document.getElementById('p2-avg-display').textContent = p2Avg;

            // Update legs
            document.getElementById('p1-legs-display').textContent = dartsGame.player1.legs;
            document.getElementById('p2-legs-display').textContent = dartsGame.player2.legs;

            // Update checkout suggestions
            updateCheckoutDisplay();
        }

        function highlightCurrentPlayer() {
            const p1Card = document.getElementById('player1-card');
            const p2Card = document.getElementById('player2-card');
            
            if (dartsGame.currentPlayer === 1) {
                p1Card.style.borderColor = 'var(--accent-gold)';
                p1Card.style.boxShadow = '0 0 20px rgba(251, 191, 36, 0.3)';
                p2Card.style.borderColor = 'transparent';
                p2Card.style.boxShadow = 'none';
                document.getElementById('current-player-turn').textContent = dartsGame.player1.name;
            } else {
                p2Card.style.borderColor = 'var(--accent-gold)';
                p2Card.style.boxShadow = '0 0 20px rgba(251, 191, 36, 0.3)';
                p1Card.style.borderColor = 'transparent';
                p1Card.style.boxShadow = 'none';
                document.getElementById('current-player-turn').textContent = dartsGame.player2.name;
            }
        }

        function quickScore(score) {
            document.getElementById('custom-dart-score').value = score;
        }

        function submitDartScore() {
            const scoreInput = document.getElementById('custom-dart-score');
            const score = parseInt(scoreInput.value);

            if (isNaN(score) || score < 0 || score > 180) {
                alert('Please enter a valid score between 0 and 180');
                return;
            }

            const currentPlayer = dartsGame.currentPlayer === 1 ? dartsGame.player1 : dartsGame.player2;
            const newScore = currentPlayer.score - score;

            // Check for bust (can't finish on anything other than double, or go below 0, or finish on 1)
            if (newScore < 0 || newScore === 1) {
                // Bust - no score deducted, turn passes
                dartsGame.history.push({
                    player: dartsGame.currentPlayer,
                    score: score,
                    remaining: currentPlayer.score,
                    bust: true
                });
                
                // Still count the darts for average
                currentPlayer.darts += 3;
                
                updateThrowHistory();
                scoreInput.value = '';
                switchPlayer();
                return;
            }

            // Valid throw
            currentPlayer.score = newScore;
            currentPlayer.totalScore += score;
            currentPlayer.darts += 3;
            currentPlayer.throws.push(score);

            dartsGame.history.push({
                player: dartsGame.currentPlayer,
                score: score,
                remaining: newScore,
                bust: false
            });

            // Check for win
            if (newScore === 0) {
                legWon();
            } else {
                updateDartsScoreboard();
                updateThrowHistory();
                scoreInput.value = '';
                switchPlayer();
            }
        }

        function switchPlayer() {
            dartsGame.currentPlayer = dartsGame.currentPlayer === 1 ? 2 : 1;
            highlightCurrentPlayer();
        }

        function legWon() {
            const winner = dartsGame.currentPlayer === 1 ? dartsGame.player1 : dartsGame.player2;
            winner.legs++;

            updateDartsScoreboard();
            updateThrowHistory();

            const legsNeeded = Math.ceil(dartsGame.legsToWin / 2);
            
            if (winner.legs >= legsNeeded) {
                // Game won!
                gameWon();
            } else {
                // Start new leg
                if (confirm(`${winner.name} wins the leg! Start next leg?`)) {
                    startNewLeg();
                }
            }
        }

        function startNewLeg() {
            dartsGame.player1.score = dartsGame.mode;
            dartsGame.player2.score = dartsGame.mode;
            dartsGame.player1.throws = [];
            dartsGame.player2.throws = [];
            dartsGame.currentPlayer = dartsGame.currentPlayer === 1 ? 2 : 1; // Loser of previous leg starts
            
            updateDartsScoreboard();
            highlightCurrentPlayer();
            document.getElementById('custom-dart-score').value = '';
        }

        async function gameWon() {
            const winner = dartsGame.currentPlayer === 1 ? dartsGame.player1 : dartsGame.player2;
            
            alert(`üéØ ${winner.name} wins the match!`);

            // Save game to history
            const p1Avg = dartsGame.player1.darts > 0 
                ? parseFloat((dartsGame.player1.totalScore / (dartsGame.player1.darts / 3)).toFixed(2))
                : 0;
            const p2Avg = dartsGame.player2.darts > 0 
                ? parseFloat((dartsGame.player2.totalScore / (dartsGame.player2.darts / 3)).toFixed(2))
                : 0;

            const game = {
                sport: 'Darts',
                gameType: state.gameType,
                player1: dartsGame.player1.name,
                player2: dartsGame.player2.name,
                date: new Date().toISOString(),
                p1Legs: dartsGame.player1.legs,
                p2Legs: dartsGame.player2.legs,
                p1Sets: 0,
                p2Sets: 0,
                p1Avg: p1Avg,
                p2Avg: p2Avg,
                winner: winner.name,
                score1: dartsGame.player1.legs,
                score2: dartsGame.player2.legs,
                mode: dartsGame.mode
            };

            state.games.push(game);
            await saveData();

            // Reset darts game
            endDartsGame();
            
            updateUserStats(); // Update user's stats after saving
        }

        function undoLastDart() {
            if (dartsGame.history.length === 0) {
                alert('No throws to undo');
                return;
            }

            const lastThrow = dartsGame.history.pop();
            const player = lastThrow.player === 1 ? dartsGame.player1 : dartsGame.player2;

            // Restore score
            if (!lastThrow.bust) {
                player.score += lastThrow.score;
                player.totalScore -= lastThrow.score;
            }
            
            player.darts -= 3;
            player.throws.pop();

            // Switch back to previous player
            dartsGame.currentPlayer = lastThrow.player;

            updateDartsScoreboard();
            updateThrowHistory();
            highlightCurrentPlayer();
        }

        function updateThrowHistory() {
            const historyDiv = document.getElementById('throw-history');
            
            if (dartsGame.history.length === 0) {
                historyDiv.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No throws yet</div>';
                return;
            }

            historyDiv.innerHTML = dartsGame.history
                .slice()
                .reverse()
                .map(throw_ => {
                    const playerName = throw_.player === 1 ? dartsGame.player1.name : dartsGame.player2.name;
                    const bustText = throw_.bust ? ' <span style="color: var(--accent-orange);">BUST!</span>' : '';
                    return `
                        <div style="padding: 8px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                            <span><strong>${playerName}</strong>: ${throw_.score}${bustText}</span>
                            <span style="color: var(--text-secondary);">Left: ${throw_.remaining}</span>
                        </div>
                    `;
                })
                .join('');
        }

        function endDartsGame() {
            if (dartsGame.active && !confirm('Are you sure you want to end this game? Progress will be lost.')) {
                return;
            }

            dartsGame.active = false;
            document.getElementById('darts-setup').classList.remove('hidden');
            document.getElementById('darts-game').classList.add('hidden');
            document.getElementById('custom-dart-score').value = '';
            document.getElementById('throw-history').innerHTML = '';
        }

        // ==================== END DARTS GAME FUNCTIONS ====================

        // ==================== PRACTICE MODE FUNCTIONS ====================

        let practiceState = {
            mode: null, // 'solo', 'checkout', 'rtb', 'cpu'
        };

        // --- Shared ---
        function startPractice(mode) {
            practiceState.mode = mode;
            document.getElementById('practice-menu').classList.add('hidden');
            document.getElementById('practice-solo').classList.add('hidden');
            document.getElementById('practice-checkout').classList.add('hidden');
            document.getElementById('practice-rtb').classList.add('hidden');
            document.getElementById('practice-cpu').classList.add('hidden');
            document.getElementById(`practice-${mode}`).classList.remove('hidden');

            if (mode === 'checkout') startCheckoutPractice();
            if (mode === 'rtb') resetRTB();
        }

        function endPractice() {
            // Save active sessions before closing
            
            // Solo: save if any legs were completed or darts were thrown
            if (practiceState.mode === 'solo') {
                // Include current in-progress leg in session totals
                const totalDarts = soloState.sessionDarts + soloState.darts;
                const totalScore = soloState.sessionTotalScore + soloState.totalScore;
                const highest = Math.max(soloState.sessionHighest, soloState.highest);
                if (totalDarts > 0) {
                    savePracticeSession({
                        mode: 'solo',
                        gameMode: soloState.mode,
                        legsCompleted: soloState.legsCompleted,
                        avg: (totalScore / (totalDarts / 3)).toFixed(2),
                        highest: highest,
                        totalDarts: totalDarts
                    });
                }
            }

            // Checkout: save if any attempts were made
            if (practiceState.mode === 'checkout' && (checkoutState.hits > 0 || checkoutState.misses > 0)) {
                const total = checkoutState.hits + checkoutState.misses;
                savePracticeSession({
                    mode: 'checkout',
                    hits: checkoutState.hits,
                    misses: checkoutState.misses,
                    hitRate: total > 0 ? ((checkoutState.hits / total) * 100).toFixed(0) + '%' : '0%',
                    dartsUsed: checkoutState.dartsUsed
                });
                // Reset for next time
                checkoutState = { target: 0, remaining: 0, hits: 0, misses: 0, dartsUsed: 0 };
            }

            // CPU: save if match was in progress (but not finished ‚Äî finished matches save themselves)
            // No action needed ‚Äî CPU saves on completion

            practiceState.mode = null;
            if (rtbTimer) clearInterval(rtbTimer);
            document.getElementById('practice-menu').classList.remove('hidden');
            document.getElementById('practice-solo').classList.add('hidden');
            document.getElementById('practice-checkout').classList.add('hidden');
            document.getElementById('practice-rtb').classList.add('hidden');
            document.getElementById('practice-cpu').classList.add('hidden');
            // Reset CPU
            document.getElementById('cpu-setup').classList.remove('hidden');
            document.getElementById('cpu-active').classList.add('hidden');
            // Reset solo
            document.getElementById('solo-setup').classList.remove('hidden');
            document.getElementById('solo-active').classList.add('hidden');
        }

        // ==================== SOLO SCORING ====================
        let soloState = { mode: 501, score: 501, darts: 0, totalScore: 0, highest: 0, throws: [], legsCompleted: 0, sessionDarts: 0, sessionTotalScore: 0, sessionHighest: 0 };

        function selectSoloMode(mode) {
            soloState.mode = mode;
            document.getElementById('solo-mode-501').classList.toggle('selected', mode === 501);
            document.getElementById('solo-mode-301').classList.toggle('selected', mode === 301);
        }

        function startSoloPractice() {
            soloState.score = soloState.mode;
            soloState.darts = 0;
            soloState.totalScore = 0;
            soloState.highest = 0;
            soloState.throws = [];
            soloState.legsCompleted = 0;
            soloState.sessionDarts = 0;
            soloState.sessionTotalScore = 0;
            soloState.sessionHighest = 0;
            document.getElementById('solo-setup').classList.add('hidden');
            document.getElementById('solo-active').classList.remove('hidden');
            updateSoloDisplay();
        }

        function resetSoloPractice() {
            soloState.score = soloState.mode;
            soloState.throws = [];
            soloState.darts = 0;
            soloState.totalScore = 0;
            soloState.highest = 0;
            updateSoloDisplay();
        }

        function soloQuickScore(score) {
            document.getElementById('solo-custom-score').value = score;
        }

        function submitSoloScore() {
            const input = document.getElementById('solo-custom-score');
            const score = parseInt(input.value);
            if (isNaN(score) || score < 0 || score > 180) { alert('Enter a valid score (0-180)'); return; }

            const newScore = soloState.score - score;
            if (newScore < 0 || newScore === 1) {
                // Bust
                soloState.throws.push({ score, bust: true, remaining: soloState.score });
                soloState.darts += 3;
            } else {
                soloState.score = newScore;
                soloState.totalScore += score;
                soloState.darts += 3;
                if (score > soloState.highest) soloState.highest = score;
                soloState.throws.push({ score, bust: false, remaining: newScore });

                if (newScore === 0) {
                    soloState.legsCompleted++;
                    soloState.sessionDarts += soloState.darts;
                    soloState.sessionTotalScore += soloState.totalScore;
                    if (soloState.highest > soloState.sessionHighest) soloState.sessionHighest = soloState.highest;
                    const legAvg = (soloState.totalScore / (soloState.darts / 3)).toFixed(2);
                    alert(`üéØ Checked out in ${soloState.darts} darts! 3-dart avg: ${legAvg}`);
                    // Reset for next leg but keep session running
                    soloState.score = soloState.mode;
                    soloState.darts = 0;
                    soloState.totalScore = 0;
                    soloState.highest = 0;
                    soloState.throws = [];
                    input.value = '';
                    updateSoloDisplay();
                    return;
                }
            }
            input.value = '';
            updateSoloDisplay();
        }

        function undoSoloScore() {
            if (soloState.throws.length === 0) return;
            const last = soloState.throws.pop();
            soloState.darts -= 3;
            if (!last.bust) {
                soloState.score += last.score;
                soloState.totalScore -= last.score;
            }
            // Recalculate highest
            soloState.highest = soloState.throws.reduce((max, t) => !t.bust && t.score > max ? t.score : max, 0);
            updateSoloDisplay();
        }

        function updateSoloDisplay() {
            document.getElementById('solo-score-display').textContent = soloState.score;
            const avg = soloState.darts > 0 ? (soloState.totalScore / (soloState.darts / 3)).toFixed(2) : '0.00';
            document.getElementById('solo-avg').textContent = avg;
            document.getElementById('solo-darts').textContent = soloState.darts;
            document.getElementById('solo-highest').textContent = soloState.highest;

            // Checkout suggestion
            const checkout = getCheckout(soloState.score);
            const el = document.getElementById('solo-checkout');
            if (checkout && soloState.score <= 170) {
                el.innerHTML = `<span style="color: var(--accent-green); font-weight: 700;">üéØ ${checkout.join(' or ')}</span>`;
            } else {
                el.innerHTML = '';
            }

            // Throw history
            const hist = document.getElementById('solo-throw-history');
            hist.innerHTML = soloState.throws.length === 0 
                ? '<div style="color: var(--text-secondary); text-align: center;">No throws yet</div>'
                : soloState.throws.slice().reverse().map(t => 
                    `<div style="padding: 4px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                        <span>${t.score}${t.bust ? ' <span style="color: var(--accent-orange);">BUST</span>' : ''}</span>
                        <span style="color: var(--text-secondary);">Left: ${t.remaining}</span>
                    </div>`
                ).join('');
        }

        // ==================== CHECKOUT PRACTICE ====================
        let checkoutState = { target: 0, remaining: 0, hits: 0, misses: 0, dartsUsed: 0 };

        function startCheckoutPractice() {
            // Random checkout between 2 and 170 (only valid checkouts)
            const validCheckouts = [];
            for (let i = 2; i <= 170; i++) {
                if (getCheckout(i)) validCheckouts.push(i);
            }
            checkoutState.target = validCheckouts[Math.floor(Math.random() * validCheckouts.length)];
            checkoutState.remaining = checkoutState.target;

            document.getElementById('checkout-target').textContent = checkoutState.target;
            const suggestion = getCheckout(checkoutState.target);
            document.getElementById('checkout-suggestion').textContent = suggestion ? 'üí° ' + suggestion.join(' or ') : '';
            document.getElementById('checkout-score-input').value = '';
            updateCheckoutStats();
        }

        function submitCheckoutScore() {
            const input = document.getElementById('checkout-score-input');
            const score = parseInt(input.value);
            if (isNaN(score) || score < 0 || score > 180) { alert('Enter a valid score (0-180)'); return; }

            checkoutState.dartsUsed += 3;
            const newRemaining = checkoutState.remaining - score;

            if (newRemaining === 0) {
                // Hit!
                checkoutState.hits++;
                updateCheckoutStats();
                input.value = '';
                setTimeout(() => {
                    startCheckoutPractice();
                }, 300);
                return;
            } else if (newRemaining < 0 || newRemaining === 1) {
                // Bust ‚Äî reset to target
                checkoutState.remaining = checkoutState.target;
                document.getElementById('checkout-target').textContent = checkoutState.target;
            } else {
                // Partial ‚Äî score deducted, keep going
                checkoutState.remaining = newRemaining;
                document.getElementById('checkout-target').textContent = checkoutState.remaining;
                const suggestion = getCheckout(checkoutState.remaining);
                document.getElementById('checkout-suggestion').textContent = suggestion ? 'üí° ' + suggestion.join(' or ') : '';
            }

            input.value = '';
            updateCheckoutStats();
        }

        function skipCheckout() {
            checkoutState.misses++;
            checkoutState.dartsUsed += 3;
            updateCheckoutStats();
            startCheckoutPractice();
        }

        function updateCheckoutStats() {
            document.getElementById('checkout-hits').textContent = checkoutState.hits;
            document.getElementById('checkout-misses').textContent = checkoutState.misses;
            const total = checkoutState.hits + checkoutState.misses;
            document.getElementById('checkout-rate').textContent = total > 0 ? ((checkoutState.hits / total) * 100).toFixed(0) + '%' : '0%';
            document.getElementById('checkout-darts-used').textContent = checkoutState.dartsUsed;
        }

        // ==================== ROUND THE BOARD ====================
        let rtbState = { current: 1, darts: 0, startTime: null, board: [] };
        let rtbTimer = null;

        function resetRTB() {
            if (rtbTimer) clearInterval(rtbTimer);
            rtbState = { current: 1, darts: 0, startTime: Date.now(), board: Array(20).fill(false) };
            document.getElementById('rtb-target').textContent = '1';
            document.getElementById('rtb-progress').textContent = '1 of 20';
            document.getElementById('rtb-darts').textContent = '0';
            document.getElementById('rtb-time').textContent = '0:00';
            renderRTBBoard();
            rtbTimer = setInterval(updateRTBTimer, 1000);
        }

        function rtbHit() {
            rtbState.darts++;
            rtbState.board[rtbState.current - 1] = true;
            rtbState.current++;

            if (rtbState.current > 20) {
                // Finished!
                clearInterval(rtbTimer);
                const elapsed = Math.floor((Date.now() - rtbState.startTime) / 1000);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                document.getElementById('rtb-darts').textContent = rtbState.darts;
                renderRTBBoard();
                savePracticeSession({
                    mode: 'rtb',
                    darts: rtbState.darts,
                    time: timeStr
                });
                alert(`üéØ Round the Board complete!\n${rtbState.darts} darts in ${timeStr}`);
                return;
            }

            document.getElementById('rtb-target').textContent = rtbState.current;
            document.getElementById('rtb-progress').textContent = `${rtbState.current} of 20`;
            document.getElementById('rtb-darts').textContent = rtbState.darts;
            renderRTBBoard();
        }

        function rtbMiss() {
            rtbState.darts++;
            document.getElementById('rtb-darts').textContent = rtbState.darts;
        }

        function updateRTBTimer() {
            const elapsed = Math.floor((Date.now() - rtbState.startTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('rtb-time').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function renderRTBBoard() {
            const board = document.getElementById('rtb-board');
            board.innerHTML = Array.from({ length: 20 }, (_, i) => {
                const num = i + 1;
                const hit = rtbState.board[i];
                const isCurrent = num === rtbState.current;
                let bg = 'var(--bg-input)';
                let border = 'var(--border)';
                let color = 'var(--text-secondary)';
                if (hit) { bg = 'var(--accent-green)'; border = 'var(--accent-green)'; color = 'var(--bg-main)'; }
                else if (isCurrent) { bg = 'var(--accent-gold)'; border = 'var(--accent-gold)'; color = 'var(--bg-main)'; }
                return `<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: ${bg}; border: 2px solid ${border}; color: ${color}; font-weight: 700; font-size: 0.9rem;">${num}</div>`;
            }).join('');
        }

        // ==================== VS COMPUTER ====================
        let cpuGame = {
            mode: 501,
            level: 5,
            legsToWin: 1,
            player: { score: 501, legs: 0, darts: 0, totalScore: 0 },
            cpu: { score: 501, legs: 0, darts: 0, totalScore: 0 },
            log: [],
            active: false
        };

        // Level config: [avgMin, avgMax, checkoutPct, bustPct]
        const cpuLevels = {
            1:  { avgMin: 12, avgMax: 30, checkoutPct: 0.05, name: 'Pub' },
            2:  { avgMin: 22, avgMax: 40, checkoutPct: 0.10, name: 'Casual' },
            3:  { avgMin: 30, avgMax: 52, checkoutPct: 0.15, name: 'Regular' },
            4:  { avgMin: 38, avgMax: 62, checkoutPct: 0.20, name: 'Decent' },
            5:  { avgMin: 48, avgMax: 72, checkoutPct: 0.28, name: 'Good' },
            6:  { avgMin: 56, avgMax: 84, checkoutPct: 0.35, name: 'Strong' },
            7:  { avgMin: 65, avgMax: 95, checkoutPct: 0.42, name: 'County' },
            8:  { avgMin: 75, avgMax: 108, checkoutPct: 0.52, name: 'Semi-Pro' },
            9:  { avgMin: 85, avgMax: 118, checkoutPct: 0.65, name: 'Pro' },
            10: { avgMin: 95, avgMax: 130, checkoutPct: 0.80, name: 'Legend' }
        };

        function selectCpuMode(mode) {
            cpuGame.mode = mode;
            document.getElementById('cpu-mode-501').classList.toggle('selected', mode === 501);
            document.getElementById('cpu-mode-301').classList.toggle('selected', mode === 301);
        }

        function selectCpuLevel(level) {
            cpuGame.level = level;
            for (let i = 1; i <= 10; i++) {
                document.getElementById(`cpu-lvl-${i}`).classList.toggle('selected', i === level);
            }
        }

        function selectCpuLegs(legs) {
            cpuGame.legsToWin = legs;
            document.getElementById('cpu-legs-1').classList.toggle('selected', legs === 1);
            document.getElementById('cpu-legs-3').classList.toggle('selected', legs === 3);
            document.getElementById('cpu-legs-5').classList.toggle('selected', legs === 5);
        }

        function startCpuGame() {
            cpuGame.active = true;
            cpuGame.player = { score: cpuGame.mode, legs: 0, darts: 0, totalScore: 0 };
            cpuGame.cpu = { score: cpuGame.mode, legs: 0, darts: 0, totalScore: 0 };
            cpuGame.log = [];

            document.getElementById('cpu-setup').classList.add('hidden');
            document.getElementById('cpu-active').classList.remove('hidden');

            const lvl = cpuLevels[cpuGame.level];
            document.getElementById('cpu-game-info').textContent = `${cpuGame.mode} ‚Äî Level ${cpuGame.level} (${lvl.name}) ‚Äî Best of ${cpuGame.legsToWin}`;
            
            updateCpuDisplay();
            document.getElementById('cpu-turn-info').textContent = 'Your turn';
        }

        function cpuQuickScore(score) {
            document.getElementById('cpu-custom-score').value = score;
        }

        function generateCpuScore(cpuRemaining) {
            const lvl = cpuLevels[cpuGame.level];
            
            // If on a checkout, attempt it
            if (cpuRemaining <= 170 && getCheckout(cpuRemaining)) {
                if (Math.random() < lvl.checkoutPct) {
                    return cpuRemaining; // Checks out!
                }
                // Didn't check out ‚Äî throw a partial score
                const partial = Math.floor(Math.random() * Math.min(cpuRemaining - 2, 60)) + 1;
                if (cpuRemaining - partial === 1 || cpuRemaining - partial < 0) {
                    return 0; // Bust effectively
                }
                return partial;
            }

            // Normal scoring throw with variance
            const avgTarget = (lvl.avgMin + lvl.avgMax) / 2;
            const range = (lvl.avgMax - lvl.avgMin) / 2;
            // Gaussian-ish distribution
            const r1 = Math.random(), r2 = Math.random();
            const gaussian = Math.sqrt(-2 * Math.log(r1)) * Math.cos(2 * Math.PI * r2);
            let score = Math.round(avgTarget + gaussian * range * 0.6);
            score = Math.max(0, Math.min(180, score));

            // Avoid busting
            if (cpuRemaining - score < 0 || cpuRemaining - score === 1) {
                score = Math.max(0, cpuRemaining - 2 - Math.floor(Math.random() * 20));
                if (score < 0) score = 0;
            }

            return score;
        }

        function submitCpuScore() {
            if (!cpuGame.active) return;
            const input = document.getElementById('cpu-custom-score');
            const score = parseInt(input.value);
            if (isNaN(score) || score < 0 || score > 180) { alert('Enter a valid score (0-180)'); return; }

            // Player's turn
            const newScore = cpuGame.player.score - score;
            cpuGame.player.darts += 3;

            if (newScore < 0 || newScore === 1) {
                cpuGame.log.unshift({ who: 'You', score: score, note: 'BUST', remaining: cpuGame.player.score });
            } else {
                cpuGame.player.score = newScore;
                cpuGame.player.totalScore += score;
                cpuGame.log.unshift({ who: 'You', score: score, note: '', remaining: newScore });

                if (newScore === 0) {
                    cpuGame.player.legs++;
                    updateCpuDisplay();
                    renderCpuLog();
                    input.value = '';
                    checkCpuMatchWin('You');
                    return;
                }
            }

            updateCpuDisplay();
            input.value = '';

            // Computer's turn
            document.getElementById('cpu-turn-info').textContent = 'ü§ñ Computer is throwing...';
            
            setTimeout(() => {
                const cpuScore = generateCpuScore(cpuGame.cpu.score);
                cpuGame.cpu.darts += 3;
                const cpuNew = cpuGame.cpu.score - cpuScore;

                if (cpuNew < 0 || cpuNew === 1 || cpuScore === 0) {
                    cpuGame.log.unshift({ who: 'ü§ñ CPU', score: cpuScore, note: cpuScore === 0 ? '' : 'BUST', remaining: cpuGame.cpu.score });
                } else {
                    cpuGame.cpu.score = cpuNew;
                    cpuGame.cpu.totalScore += cpuScore;
                    cpuGame.log.unshift({ who: 'ü§ñ CPU', score: cpuScore, note: cpuNew === 0 ? 'CHECKOUT!' : '', remaining: cpuNew });

                    if (cpuNew === 0) {
                        cpuGame.cpu.legs++;
                        updateCpuDisplay();
                        renderCpuLog();
                        checkCpuMatchWin('Computer');
                        return;
                    }
                }

                updateCpuDisplay();
                renderCpuLog();
                document.getElementById('cpu-turn-info').textContent = 'Your turn';
            }, 800);
        }

        function checkCpuMatchWin(winner) {
            const legsNeeded = Math.ceil(cpuGame.legsToWin / 2);
            const pWon = cpuGame.player.legs >= legsNeeded;
            const cWon = cpuGame.cpu.legs >= legsNeeded;

            if (pWon || cWon) {
                const msg = pWon ? 'üéâ You win the match!' : 'ü§ñ Computer wins the match!';
                const pAvg = cpuGame.player.darts > 0 ? (cpuGame.player.totalScore / (cpuGame.player.darts / 3)).toFixed(2) : '0.00';
                const cAvg = cpuGame.cpu.darts > 0 ? (cpuGame.cpu.totalScore / (cpuGame.cpu.darts / 3)).toFixed(2) : '0.00';
                
                // Save practice session (NOT to games/leaderboard)
                savePracticeSession({
                    mode: 'cpu',
                    cpuLevel: cpuGame.level,
                    cpuLevelName: cpuLevels[cpuGame.level].name,
                    gameMode: cpuGame.mode,
                    won: pWon,
                    playerLegs: cpuGame.player.legs,
                    cpuLegs: cpuGame.cpu.legs,
                    playerAvg: pAvg,
                    cpuAvg: cAvg
                });
                
                alert(`${msg}\n\nYour avg: ${pAvg}\nCPU avg: ${cAvg}\nLegs: ${cpuGame.player.legs} - ${cpuGame.cpu.legs}`);
                cpuGame.active = false;
                document.getElementById('cpu-turn-info').textContent = pWon ? 'üéâ You won!' : 'ü§ñ Computer won!';
            } else {
                // Start new leg
                alert(`${winner} wins the leg! Score: ${cpuGame.player.legs} - ${cpuGame.cpu.legs}`);
                cpuGame.player.score = cpuGame.mode;
                cpuGame.cpu.score = cpuGame.mode;
                updateCpuDisplay();
                document.getElementById('cpu-turn-info').textContent = 'Your turn ‚Äî new leg!';
            }
        }

        function updateCpuDisplay() {
            document.getElementById('cpu-p-score').textContent = cpuGame.player.score;
            document.getElementById('cpu-c-score').textContent = cpuGame.cpu.score;
            document.getElementById('cpu-p-legs').textContent = cpuGame.player.legs;
            document.getElementById('cpu-c-legs').textContent = cpuGame.cpu.legs;

            const pAvg = cpuGame.player.darts > 0 ? (cpuGame.player.totalScore / (cpuGame.player.darts / 3)).toFixed(2) : '0.00';
            const cAvg = cpuGame.cpu.darts > 0 ? (cpuGame.cpu.totalScore / (cpuGame.cpu.darts / 3)).toFixed(2) : '0.00';
            document.getElementById('cpu-p-avg').textContent = pAvg;
            document.getElementById('cpu-c-avg').textContent = cAvg;

            // Checkout displays
            const pCheckout = getCheckout(cpuGame.player.score);
            const pEl = document.getElementById('cpu-p-checkout');
            pEl.innerHTML = (pCheckout && cpuGame.player.score <= 170) 
                ? `<span style="color: var(--accent-green); font-weight: 700;">üéØ ${pCheckout.join(' or ')}</span>` : '';

            const cCheckout = getCheckout(cpuGame.cpu.score);
            const cEl = document.getElementById('cpu-c-checkout');
            cEl.innerHTML = (cCheckout && cpuGame.cpu.score <= 170) 
                ? `<span style="color: var(--accent-green); font-weight: 700;">üéØ ${cCheckout.join(' or ')}</span>` : '';

            renderCpuLog();
        }

        function renderCpuLog() {
            const logDiv = document.getElementById('cpu-match-log');
            logDiv.innerHTML = cpuGame.log.length === 0
                ? '<div style="color: var(--text-secondary); text-align: center;">No throws yet</div>'
                : cpuGame.log.map(entry =>
                    `<div style="padding: 4px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                        <span><strong>${entry.who}</strong>: ${entry.score} ${entry.note ? `<span style="color: ${entry.note === 'BUST' ? 'var(--accent-orange)' : 'var(--accent-green)'};">${entry.note}</span>` : ''}</span>
                        <span style="color: var(--text-secondary);">Left: ${entry.remaining}</span>
                    </div>`
                ).join('');
        }

        // ==================== PRACTICE HISTORY TRACKING ====================

        async function savePracticeSession(session) {
            session.date = new Date().toISOString();
            session.player = state.currentUser ? state.currentUser.name : 'Guest';
            state.practiceHistory.unshift(session); // newest first
            // Keep max 200 sessions
            if (state.practiceHistory.length > 200) state.practiceHistory = state.practiceHistory.slice(0, 200);
            await savePracticeData();
            renderPracticeHistory();
        }

        function renderPracticeHistory() {
            const filter = document.getElementById('practice-history-filter').value;
            let sessions = state.practiceHistory || [];
            if (filter !== 'all') {
                sessions = sessions.filter(s => s.mode === filter);
            }

            const listEl = document.getElementById('practice-history-list');
            const summaryEl = document.getElementById('practice-summary');
            const summaryStats = document.getElementById('practice-summary-stats');

            if (sessions.length === 0) {
                listEl.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No practice sessions yet. Get practising!</div>';
                summaryEl.style.display = 'none';
                return;
            }

            listEl.innerHTML = sessions.map(s => {
                const date = new Date(s.date);
                const dateStr = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                const timeStr = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                let icon = 'üéØ', label = '', detail = '';

                if (s.mode === 'solo') {
                    icon = 'üéØ';
                    label = `Solo ${s.gameMode}`;
                    detail = `${s.legsCompleted} leg${s.legsCompleted !== 1 ? 's' : ''} ‚Äî Avg: <strong>${s.avg}</strong> ‚Äî Best: ${s.highest} ‚Äî ${s.totalDarts} darts`;
                } else if (s.mode === 'checkout') {
                    icon = '‚úÖ';
                    label = 'Checkout';
                    detail = `${s.hits}/${s.hits + s.misses} hit (${s.hitRate}) ‚Äî ${s.dartsUsed} darts`;
                } else if (s.mode === 'rtb') {
                    icon = 'üîÑ';
                    label = 'Round the Board';
                    detail = `Completed in <strong>${s.darts} darts</strong> ‚Äî Time: ${s.time}`;
                } else if (s.mode === 'cpu') {
                    icon = 'ü§ñ';
                    label = `VS CPU Lvl ${s.cpuLevel}`;
                    const result = s.won ? '<span style="color: var(--accent-green);">WIN</span>' : '<span style="color: var(--accent-orange);">LOSS</span>';
                    detail = `${result} ${s.playerLegs}-${s.cpuLegs} ‚Äî Your avg: <strong>${s.playerAvg}</strong> vs CPU: ${s.cpuAvg}`;
                }

                return `
                    <div style="padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-size: 1.1rem;">${icon}</span>
                                <strong>${label}</strong>
                                <span style="font-size: 0.75rem; color: var(--text-secondary); background: var(--bg-input); padding: 2px 6px; border-radius: 4px;">${s.player}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${detail}</div>
                        </div>
                        <div style="text-align: right; font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap;">
                            ${dateStr}<br>${timeStr}
                        </div>
                    </div>
                `;
            }).join('');

            // Summary stats
            summaryEl.style.display = 'block';
            const totalSessions = sessions.length;
            const soloSessions = sessions.filter(s => s.mode === 'solo');
            const cpuSessions = sessions.filter(s => s.mode === 'cpu');
            const checkoutSessions = sessions.filter(s => s.mode === 'checkout');
            const rtbSessions = sessions.filter(s => s.mode === 'rtb');

            // Best solo avg
            const bestSoloAvg = soloSessions.length > 0
                ? Math.max(...soloSessions.map(s => parseFloat(s.avg) || 0)).toFixed(2)
                : '‚Äî';
            // Best RTB
            const bestRTB = rtbSessions.length > 0
                ? Math.min(...rtbSessions.map(s => s.darts))
                : '‚Äî';
            // CPU win rate
            const cpuWins = cpuSessions.filter(s => s.won).length;
            const cpuWinRate = cpuSessions.length > 0 ? ((cpuWins / cpuSessions.length) * 100).toFixed(0) + '%' : '‚Äî';
            // Best checkout rate
            const bestCheckout = checkoutSessions.length > 0
                ? checkoutSessions.reduce((best, s) => {
                    const rate = parseInt(s.hitRate);
                    return rate > parseInt(best) ? s.hitRate : best;
                }, '0%')
                : '‚Äî';

            summaryStats.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-family: 'Bangers', cursive; font-size: 1.5rem; color: var(--accent-gold);">${totalSessions}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Total Sessions</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-family: 'Bangers', cursive; font-size: 1.5rem; color: var(--accent-green);">${bestSoloAvg}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Best Solo Avg</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-family: 'Bangers', cursive; font-size: 1.5rem; color: var(--accent-gold);">${bestRTB}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Best RTB (darts)</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-family: 'Bangers', cursive; font-size: 1.5rem; color: var(--accent-green);">${cpuWinRate}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">VS CPU Win Rate</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-family: 'Bangers', cursive; font-size: 1.5rem; color: var(--accent-gold);">${bestCheckout}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Best Checkout %</div>
                </div>
            `;
        }

        async function clearPracticeHistory() {
            if (!confirm('Clear all practice history? This won\'t affect your game data or leaderboards.')) return;
            state.practiceHistory = [];
            await savePracticeData();
            renderPracticeHistory();
        }

        // ==================== END PRACTICE MODE FUNCTIONS ====================

        // ==================== POKER SESSION FUNCTIONS ====================

        function togglePokerRules() {
            const panel = document.getElementById('poker-rules-panel');
            const arrow = document.getElementById('poker-rules-arrow');
            panel.classList.toggle('hidden');
            arrow.style.transform = panel.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }

        function togglePokerHands() {
            const panel = document.getElementById('poker-hands-panel');
            const arrow = document.getElementById('poker-hands-arrow');
            panel.classList.toggle('hidden');
            arrow.style.transform = panel.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }

        let pokerPlayers = [];

        function renderPokerProfileButtons() {
            const container = document.getElementById('poker-profile-buttons');
            if (!container) return;
            
            if (state.profiles.length === 0) {
                container.innerHTML = '<div style="color: #ff9800; font-size: 0.85rem; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px dashed #2d6b45; text-align: center;">‚ö†Ô∏è No profiles yet ‚Äî go to <strong style="color: #f0d060;">Settings</strong> or the <strong style="color: #f0d060;">login screen</strong> to create profiles first.</div>';
                return;
            }

            const addedNames = pokerPlayers.map(p => p.name);
            
            container.innerHTML = state.profiles.map(profile => {
                const isAdded = addedNames.includes(profile.name);
                return `
                    <button onclick="${isAdded ? `removePokerPlayerByName('${profile.name.replace(/'/g, "\\'")}')` : `addPokerProfilePlayer('${profile.name.replace(/'/g, "\\'")}')`}" 
                        style="padding: 8px 14px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: 1px solid ${isAdded ? '#4caf50' : '#3d8b5a'}; transition: all 0.2s;
                        background: ${isAdded ? 'rgba(76,175,80,0.2)' : 'linear-gradient(135deg, #2d6b45, #1a472a)'}; 
                        color: ${isAdded ? '#4caf50' : '#f0d060'};">
                        ${isAdded ? '‚úÖ ' : '‚ô† '}${profile.name}
                    </button>
                `;
            }).join('');
        }

        function addPokerProfilePlayer(name) {
            if (pokerPlayers.find(p => p.name === name)) return;

            const buyIn = parseFloat(document.getElementById('poker-buyin').value) || 0;
            if (buyIn <= 0) {
                alert('Please enter a buy-in amount first');
                return;
            }

            pokerPlayers.push({
                name: name,
                boughtIn: true,
                buyIns: 1,
                buyInPerUnit: buyIn,
                finalAmount: 0
            });

            renderPokerPlayers();
        }

        function removePokerPlayerByName(name) {
            const index = pokerPlayers.findIndex(p => p.name === name);
            if (index !== -1) {
                pokerPlayers.splice(index, 1);
                renderPokerPlayers();
            }
        }

        const suits = ['‚ô†', '‚ô•', '‚ô£', '‚ô¶'];

        function renderPokerPlayers() {
            const list = document.getElementById('poker-players-list');
            const summary = document.getElementById('poker-session-summary');
            
            if (pokerPlayers.length === 0) {
                list.innerHTML = '<div class="poker-empty-table"><div style="font-size: 2rem; margin-bottom: 8px;">‚ô† ‚ô• ‚ô£ ‚ô¶</div>No players at the table yet</div>';
                summary.classList.add('hidden');
                renderPokerProfileButtons();
                return;
            }

            summary.classList.remove('hidden');
            const paid = pokerPlayers.filter(p => p.buyIns > 0);
            const totalBuyIns = pokerPlayers.reduce((sum, p) => sum + p.buyIns, 0);
            const totalPot = pokerPlayers.reduce((sum, p) => sum + (p.buyIns * p.buyInPerUnit), 0);
            document.getElementById('poker-total-players').textContent = pokerPlayers.length;
            document.getElementById('poker-total-paid').textContent = paid.length;
            document.getElementById('poker-total-pot').textContent = '¬£' + totalPot.toFixed(0);

            list.innerHTML = pokerPlayers.map((player, index) => {
                const totalOwed = player.buyIns * player.buyInPerUnit;
                const isPaid = player.buyIns > 0;
                const suit = suits[index % 4];
                const isRed = suit === '‚ô•' || suit === '‚ô¶';
                return `
                <div class="poker-player-card ${isPaid ? 'poker-player-paid' : 'poker-player-unpaid'}" data-suit="${suit}">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                        <div class="poker-ace ${isRed ? 'red' : ''}" style="font-size: 0.65rem;">A<br>${suit}</div>
                        <div>
                            <div style="font-weight: 700; font-size: 1rem; color: #f0f0f0;">${player.name}</div>
                            <div style="font-size: 0.8rem; margin-top: 2px; color: ${isPaid ? '#4caf50' : '#ff9800'};">
                                ${isPaid ? '‚úÖ ¬£' + totalOwed.toFixed(0) + ' (' + player.buyIns + ' buy-in' + (player.buyIns > 1 ? 's' : '') + ')' : '‚ùå Not Paid'}
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <button onclick="changePokerBuyIns(${index}, -1)" style="background: rgba(0,0,0,0.3); color: #c8e6c9; border: 1px solid #2d6b45; width: 32px; height: 32px; border-radius: 6px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center;">‚àí</button>
                        <span style="font-weight: 700; min-width: 20px; text-align: center; color: #f0d060;">${player.buyIns}</span>
                        <button onclick="changePokerBuyIns(${index}, 1)" style="background: #2d6b45; color: white; border: none; width: 32px; height: 32px; border-radius: 6px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
                        <button onclick="removePokerPlayer(${index})" style="background: transparent; color: #8fbc8f; border: 1px solid #2d6b45; padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; margin-left: 4px;">‚úï</button>
                    </div>
                </div>
                `;
            }).join('');
            
            renderPokerProfileButtons();
        }

        function changePokerBuyIns(index, delta) {
            const newCount = pokerPlayers[index].buyIns + delta;
            if (newCount < 0) return;
            pokerPlayers[index].buyIns = newCount;
            pokerPlayers[index].boughtIn = newCount > 0;
            renderPokerPlayers();
        }

        function togglePokerPaid(index) {
            const buyIn = parseFloat(document.getElementById('poker-buyin').value) || 0;
            if (pokerPlayers[index].buyIns > 0) {
                pokerPlayers[index].buyIns = 0;
                pokerPlayers[index].boughtIn = false;
            } else {
                pokerPlayers[index].buyIns = 1;
                pokerPlayers[index].boughtIn = true;
                pokerPlayers[index].buyInPerUnit = buyIn;
            }
            renderPokerPlayers();
        }

        function removePokerPlayer(index) {
            pokerPlayers.splice(index, 1);
            renderPokerPlayers();
        }

        function finishPokerSetup() {
            if (pokerPlayers.length < 2) {
                alert('Please add at least 2 players');
                return;
            }

            document.getElementById('poker-setup-done').classList.add('hidden');
            document.getElementById('poker-players-final').classList.remove('hidden');
            
            const maxPlace = Math.min(pokerPlayers.length, 5);
            const finalsList = document.getElementById('poker-finals-list');
            finalsList.innerHTML = pokerPlayers.map((player, index) => {
                const totalBuyIn = player.buyIns * player.buyInPerUnit;
                let options = '<option value="0">‚Äî</option>';
                for (let i = 1; i <= maxPlace; i++) {
                    const pts = i === 1 ? 3 : i <= 3 ? 2 : 1;
                    const medal = i === 1 ? 'ü•á' : i === 2 ? 'ü•à' : i === 3 ? 'ü•â' : '';
                    options += `<option value="${i}">${medal} ${i}${i===1?'st':i===2?'nd':i===3?'rd':'th'} (${pts}pts)</option>`;
                }
                return `
                <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 12px; margin-bottom: 10px; border: 1px solid #2d6b45;">
                    <div style="font-weight: 700; color: #f0f0f0; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <span class="poker-ace ${index % 2 === 1 ? 'red' : ''}" style="font-size: 0.55rem;">A<br>${suits[index % 4]}</span>
                        ${player.name}
                        <span style="color: #8fbc8f; font-size: 0.8rem; font-weight: 400;">¬£${totalBuyIn.toFixed(0)} (${player.buyIns}√ó buy-in)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div>
                            <label style="font-size: 0.75rem; color: #8fbc8f;">Placement</label>
                            <select id="poker-place-${index}" style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); color: #f0f0f0; border: 1px solid #2d6b45; border-radius: 6px;">
                                ${options}
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.75rem; color: #8fbc8f;">Final Amount (¬£)</label>
                            <input type="number" id="poker-final-${index}" min="0" step="0.01" placeholder="0.00" 
                                   value="${totalBuyIn}" style="background: rgba(0,0,0,0.3) !important; border-color: #2d6b45 !important; color: #f0f0f0 !important;">
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        async function savePokerSession() {
            // Check for duplicate placements
            const placements = pokerPlayers.map((_, i) => parseInt(document.getElementById(`poker-place-${i}`).value) || 0);
            const usedPlacements = placements.filter(p => p > 0);
            const hasDuplicates = usedPlacements.length !== new Set(usedPlacements).size;
            if (hasDuplicates) {
                alert('Each placement can only be assigned to one player');
                return;
            }

            // Calculate final amounts, placements, and points
            const results = pokerPlayers.map((player, index) => {
                const totalBuyIn = player.buyIns * player.buyInPerUnit;
                const finalAmount = parseFloat(document.getElementById(`poker-final-${index}`).value) || 0;
                const profitLoss = finalAmount - totalBuyIn;
                const placement = parseInt(document.getElementById(`poker-place-${index}`).value) || 0;
                let placementPoints = 0;
                if (placement === 1) placementPoints = 3;
                else if (placement >= 2 && placement <= 3) placementPoints = 2;
                else if (placement >= 4 && placement <= 5) placementPoints = 1;
                
                return {
                    name: player.name,
                    boughtIn: player.buyIns > 0,
                    buyIns: player.buyIns,
                    buyInPerUnit: player.buyInPerUnit,
                    buyIn: totalBuyIn,
                    finalAmount: finalAmount,
                    profitLoss: profitLoss,
                    placement: placement,
                    placementPoints: placementPoints
                };
            });

            const buyIn = parseFloat(document.getElementById('poker-buyin').value);
            const winner = results.find(p => p.placement === 1);

            const game = {
                sport: 'Poker',
                gameType: 'poker-session',
                date: new Date().toISOString(),
                buyIn: buyIn,
                players: results,
                winner: winner ? winner.name : results.reduce((max, p) => p.profitLoss > max.profitLoss ? p : max, results[0]).name
            };

            state.games.push(game);
            await saveData();

            alert('Poker session saved!');
            
            // Reset
            pokerPlayers = [];
            document.getElementById('poker-buyin').value = '10';
            renderPokerPlayers();
            document.getElementById('poker-setup-done').classList.remove('hidden');
            document.getElementById('poker-players-final').classList.add('hidden');
            
            updateUserStats(); // Update user's stats after saving
        }

        // ==================== END POKER SESSION FUNCTIONS ====================

        async function saveGame() {
            // If darts game is active, don't allow saving through this form
            if (state.selectedSport === 'Darts' && dartsGame.active) {
                alert('Please finish or end the current darts game first');
                return;
            }

            let player1, player2, score1, score2;
            
            if (state.gameType === 'singles') {
                player1 = document.getElementById('player1').value.trim();
                player2 = document.getElementById('player2').value.trim();
                
                if (!player1 || !player2) {
                    alert('Please enter both player names');
                    return;
                }
            } else {
                if (state.team1Players.length === 0 || state.team2Players.length === 0) {
                    alert('Please add players to both teams');
                    return;
                }
                player1 = state.team1Players.join(', ');
                player2 = state.team2Players.join(', ');
            }
            
            const game = {
                sport: state.selectedSport,
                gameType: state.gameType,
                player1,
                player2,
                date: new Date().toISOString(),
            };
            
            if (state.selectedSport === 'Darts') {
                game.p1Legs = parseInt(document.getElementById('p1-legs').value) || 0;
                game.p2Legs = parseInt(document.getElementById('p2-legs').value) || 0;
                game.p1Sets = parseInt(document.getElementById('p1-sets').value) || 0;
                game.p2Sets = parseInt(document.getElementById('p2-sets').value) || 0;
                game.p1Avg = parseFloat(document.getElementById('p1-avg').value) || 0;
                game.p2Avg = parseFloat(document.getElementById('p2-avg').value) || 0;
                
                // Determine winner based on sets, then legs
                if (game.p1Sets > game.p2Sets || (game.p1Sets === game.p2Sets && game.p1Legs > game.p2Legs)) {
                    game.winner = player1;
                    game.score1 = game.p1Sets;
                    game.score2 = game.p2Sets;
                } else if (game.p2Sets > game.p1Sets || (game.p2Sets === game.p1Sets && game.p2Legs > game.p1Legs)) {
                    game.winner = player2;
                    game.score1 = game.p1Sets;
                    game.score2 = game.p2Sets;
                } else {
                    game.winner = 'Draw';
                    game.score1 = game.p1Sets;
                    game.score2 = game.p2Sets;
                }
            } else {
                score1 = parseInt(document.getElementById('score1').value) || 0;
                score2 = parseInt(document.getElementById('score2').value) || 0;
                
                game.score1 = score1;
                game.score2 = score2;
                
                if (score1 > score2) {
                    game.winner = player1;
                } else if (score2 > score1) {
                    game.winner = player2;
                } else {
                    game.winner = 'Draw';
                }
            }
            
            state.games.push(game);
            await saveData();
            
            // Reset form
            if (state.gameType === 'singles') {
                document.getElementById('player1').value = '';
                document.getElementById('player2').value = '';
            } else {
                state.team1Players = [];
                state.team2Players = [];
                renderTeamPlayers();
            }
            
            if (state.selectedSport === 'Darts') {
                document.getElementById('p1-legs').value = '0';
                document.getElementById('p2-legs').value = '0';
                document.getElementById('p1-sets').value = '0';
                document.getElementById('p2-sets').value = '0';
                document.getElementById('p1-avg').value = '';
                document.getElementById('p2-avg').value = '';
            } else {
                document.getElementById('score1').value = '0';
                document.getElementById('score2').value = '0';
            }
            
            alert('Game saved successfully!');
            updateUserStats(); // Update user's stats after saving
        }

        function calculatePlayerStats() {
            const playerStats = {};
            
            state.games.forEach(game => {
                // Handle poker sessions differently
                if (game.sport === 'Poker' && game.players) {
                    game.players.forEach(player => {
                        if (!playerStats[player.name]) {
                            playerStats[player.name] = { points: 0, wins: 0, draws: 0, losses: 0, games: 0, pokerProfit: 0 };
                        }
                        
                        playerStats[player.name].games++;
                        playerStats[player.name].pokerProfit = (playerStats[player.name].pokerProfit || 0) + player.profitLoss;
                        
                        // Use placement points if available, fall back to old system
                        if (player.placementPoints !== undefined) {
                            playerStats[player.name].points += player.placementPoints;
                            if (player.placement === 1) playerStats[player.name].wins++;
                            else if (player.placement === 0 || !player.placement) playerStats[player.name].losses++;
                        } else {
                            // Legacy support for old sessions
                            if (game.winner === player.name) {
                                playerStats[player.name].wins++;
                                playerStats[player.name].points += 3;
                            } else if (player.profitLoss === 0) {
                                playerStats[player.name].draws++;
                                playerStats[player.name].points += 1;
                            } else {
                                playerStats[player.name].losses++;
                            }
                        }
                    });
                    return;
                }
                
                // Handle singles
                if (game.gameType === 'singles') {
                    const players = [game.player1, game.player2];
                    
                    players.forEach(player => {
                        if (!playerStats[player]) {
                            playerStats[player] = { points: 0, wins: 0, draws: 0, losses: 0, games: 0, pokerProfit: 0 };
                        }
                        
                        playerStats[player].games++;
                        
                        if (game.winner === player) {
                            playerStats[player].wins++;
                            playerStats[player].points += 3;
                        } else if (game.winner === 'Draw') {
                            playerStats[player].draws++;
                            playerStats[player].points += 1;
                        } else {
                            playerStats[player].losses++;
                        }
                    });
                } else if (game.gameType === 'teams') {
                    // Handle teams - each player gets the result
                    const team1 = game.player1.split(', ');
                    const team2 = game.player2.split(', ');
                    const allPlayers = [...team1, ...team2];
                    
                    allPlayers.forEach(player => {
                        if (!playerStats[player]) {
                            playerStats[player] = { points: 0, wins: 0, draws: 0, losses: 0, games: 0, pokerProfit: 0 };
                        }
                        
                        playerStats[player].games++;
                        
                        const isTeam1 = team1.includes(player);
                        const teamWon = isTeam1 ? game.winner === game.player1 : game.winner === game.player2;
                        
                        if (game.winner === 'Draw') {
                            playerStats[player].draws++;
                            playerStats[player].points += 1;
                        } else if (teamWon) {
                            playerStats[player].wins++;
                            playerStats[player].points += 3;
                        } else {
                            playerStats[player].losses++;
                        }
                    });
                }
            });
            
            return playerStats;
        }

        function updateLeaderboards() {
            const playerStats = calculatePlayerStats();
            const sortedPlayers = Object.entries(playerStats)
                .sort((a, b) => b[1].points - a[1].points);
            
            const overallList = document.getElementById('overall-leaderboard');
            overallList.innerHTML = sortedPlayers.map(([player, stats], index) => {
                let rankClass = '';
                if (index === 0) rankClass = 'first';
                else if (index === 1) rankClass = 'second';
                else if (index === 2) rankClass = 'third';
                
                return `
                    <li class="leaderboard-item" style="animation-delay: ${index * 0.05}s">
                        <div class="rank ${rankClass}">#${index + 1}</div>
                        <div class="player-info">
                            <div class="player-name">${player}</div>
                            <div class="player-stats">${stats.wins}W - ${stats.draws}D - ${stats.losses}L (${stats.games} games)</div>
                        </div>
                        <div class="points">${stats.points}</div>
                    </li>
                `;
            }).join('');
        }

        function updateSportLeaderboard() {
            const sport = document.getElementById('sport-filter').value;
            if (!sport) {
                document.getElementById('sport-leaderboard').innerHTML = '<li style="color: var(--text-secondary); padding: 20px; text-align: center;">Select a sport to view leaderboard</li>';
                return;
            }
            
            const sportGames = state.games.filter(g => g.sport === sport);
            const playerStats = {};
            
            sportGames.forEach(game => {
                if (game.gameType === 'singles') {
                    const players = [game.player1, game.player2];
                    
                    players.forEach(player => {
                        if (!playerStats[player]) {
                            playerStats[player] = { points: 0, wins: 0, draws: 0, losses: 0, games: 0 };
                        }
                        
                        playerStats[player].games++;
                        
                        if (game.winner === player) {
                            playerStats[player].wins++;
                            playerStats[player].points += 3;
                        } else if (game.winner === 'Draw') {
                            playerStats[player].draws++;
                            playerStats[player].points += 1;
                        } else {
                            playerStats[player].losses++;
                        }
                    });
                } else {
                    const team1 = game.player1.split(', ');
                    const team2 = game.player2.split(', ');
                    const allPlayers = [...team1, ...team2];
                    
                    allPlayers.forEach(player => {
                        if (!playerStats[player]) {
                            playerStats[player] = { points: 0, wins: 0, draws: 0, losses: 0, games: 0 };
                        }
                        
                        playerStats[player].games++;
                        
                        const isTeam1 = team1.includes(player);
                        const teamWon = isTeam1 ? game.winner === game.player1 : game.winner === game.player2;
                        
                        if (game.winner === 'Draw') {
                            playerStats[player].draws++;
                            playerStats[player].points += 1;
                        } else if (teamWon) {
                            playerStats[player].wins++;
                            playerStats[player].points += 3;
                        } else {
                            playerStats[player].losses++;
                        }
                    });
                }
            });
            
            const sortedPlayers = Object.entries(playerStats)
                .sort((a, b) => b[1].points - a[1].points);
            
            const sportList = document.getElementById('sport-leaderboard');
            if (sortedPlayers.length === 0) {
                sportList.innerHTML = '<li style="color: var(--text-secondary); padding: 20px; text-align: center;">No games recorded for this sport yet</li>';
                return;
            }
            
            sportList.innerHTML = sortedPlayers.map(([player, stats], index) => {
                let rankClass = '';
                if (index === 0) rankClass = 'first';
                else if (index === 1) rankClass = 'second';
                else if (index === 2) rankClass = 'third';
                
                return `
                    <li class="leaderboard-item" style="animation-delay: ${index * 0.05}s">
                        <div class="rank ${rankClass}">#${index + 1}</div>
                        <div class="player-info">
                            <div class="player-name">${player}</div>
                            <div class="player-stats">${stats.wins}W - ${stats.draws}D - ${stats.losses}L (${stats.games} games)</div>
                        </div>
                        <div class="points">${stats.points}</div>
                    </li>
                `;
            }).join('');
        }

        function updateHistory() {
            const filter = document.getElementById('history-sport-filter').value;
            const filteredGames = filter === 'all' 
                ? state.games 
                : state.games.filter(g => g.sport === filter);
            
            const historyList = document.getElementById('game-history-list');
            
            if (filteredGames.length === 0) {
                historyList.innerHTML = '<li style="color: var(--text-secondary); padding: 20px; text-align: center;">No games recorded yet</li>';
                return;
            }
            
            historyList.innerHTML = filteredGames
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(game => {
                    const date = new Date(game.date).toLocaleDateString();
                    let scoreText = '';
                    
                    if (game.sport === 'Darts') {
                        const modeText = game.mode ? ` (${game.mode})` : '';
                        scoreText = `
                            <div class="game-score">
                                <span class="${game.winner === game.player1 ? 'winner' : ''}">${game.player1}</span>
                                ${game.p1Legs} legs - Avg: ${game.p1Avg}
                                <br>
                                <span class="${game.winner === game.player2 ? 'winner' : ''}">${game.player2}</span>
                                ${game.p2Legs} legs - Avg: ${game.p2Avg}
                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px;">Mode: ${game.mode || '501'}${modeText}</div>
                            </div>
                        `;
                    } else if (game.sport === 'Poker') {
                        const playerResults = game.players
                            .slice()
                            .sort((a, b) => (a.placement || 99) - (b.placement || 99))
                            .map(p => {
                                const medal = p.placement === 1 ? 'ü•á' : p.placement === 2 ? 'ü•à' : p.placement === 3 ? 'ü•â' : p.placement ? `${p.placement}th` : '‚Äî';
                                const pts = p.placementPoints ? `+${p.placementPoints}pt${p.placementPoints > 1 ? 's' : ''}` : '';
                                return `<div style="padding: 4px 0; display: flex; justify-content: space-between;">
                                    <span>${medal} ${p.name}</span>
                                    <span style="color: ${p.profitLoss >= 0 ? 'var(--accent-green)' : 'var(--accent-orange)'};">${p.profitLoss >= 0 ? '+' : ''}¬£${p.profitLoss.toFixed(2)} ${pts ? '<span style="color: var(--accent-gold); font-size: 0.8rem;">(' + pts + ')</span>' : ''}</span>
                                </div>`;
                            }).join('');
                        scoreText = `
                            <div class="game-score">
                                <div style="margin-bottom: 8px;"><strong>Buy-in: ¬£${game.buyIn.toFixed(2)}</strong></div>
                                ${playerResults}
                            </div>
                        `;
                    } else {
                        scoreText = `
                            <div class="game-score">
                                <span class="${game.winner === game.player1 ? 'winner' : ''}">${game.player1}</span>
                                ${game.score1} - ${game.score2}
                                <span class="${game.winner === game.player2 ? 'winner' : ''}">${game.player2}</span>
                            </div>
                        `;
                    }
                    
                    return `
                        <li class="game-item">
                            <div class="game-header">
                                <span class="sport-badge">${game.sport}</span>
                                <span class="game-date">${date}</span>
                            </div>
                            ${scoreText}
                            ${game.gameType === 'teams' ? '<div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px;">Team Game</div>' : ''}
                        </li>
                    `;
                }).join('');
        }

        function updateUI() {
            // Update sport filters
            const sportFilter = document.getElementById('sport-filter');
            const historyFilter = document.getElementById('history-sport-filter');
            
            const sportOptions = state.sports.map(s => `<option value="${s}">${s}</option>`).join('');
            sportFilter.innerHTML = '<option value="">Select a sport</option>' + sportOptions;
            historyFilter.innerHTML = '<option value="all">All Sports</option>' + sportOptions;
            
            // Update sports list in settings
            const sportsList = document.getElementById('sports-list');
            sportsList.innerHTML = state.sports.map(sport => 
                `<div class="player-chip" style="display: inline-block; margin: 5px;">${sport}</div>`
            ).join('');

            // Update profile datalist for player name suggestions
            updateProfileDatalist();
        }

        function updateProfileDatalist() {
            const datalist = document.getElementById('profile-names');
            if (datalist) {
                datalist.innerHTML = state.profiles.map(p => `<option value="${p.name}">`).join('');
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'sports-tracker-data.json';
            link.click();
        }

        async function clearAllData() {
            try {
                await firebaseStorage.delete('sports');
                await firebaseStorage.delete('games');
                await firebaseStorage.delete('profiles');
                await firebaseStorage.delete('currentUser');
                await firebaseStorage.delete('notifications');
                await firebaseStorage.delete('practiceHistory');
                state.sports = ['Darts', 'Pool-US', 'Pool-UK', 'Badminton', 'Poker'];
                state.games = [];
                state.practiceHistory = [];
                state.profiles = [];
                state.currentUser = null;
                updateUI();
                renderPracticeHistory();
                alert('All data cleared!');
                logoutUser();
            } catch (error) {
                console.error('Error clearing data:', error);
            }
        }

        // Initialize
        selectGameType('singles');
        // Trigger default sport selection so darts UI shows correctly
        document.querySelector('.sport-btn[data-sport="Darts"]').click();
        // Only load data if group code is already set
        if (groupCode) {
            verifyAndConnect();
        }

        // PWA: Show install instructions based on device
        (function detectInstallMethod() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            
            if (isStandalone) {
                const msg = document.getElementById('pwa-installed-msg');
                if (msg) msg.style.display = 'block';
            } else if (isIOS) {
                const ios = document.getElementById('pwa-ios-instructions');
                if (ios) ios.style.display = 'block';
            } else if (isAndroid) {
                // Android: show instructions, install button will also show via beforeinstallprompt
                const android = document.getElementById('pwa-android-instructions');
                if (android) android.style.display = 'block';
            } else {
                // Desktop or other: show install button if available, or Android-style instructions
                const android = document.getElementById('pwa-android-instructions');
                if (android) android.style.display = 'block';
            }
        })();
    </script>
</body>
</html>